<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles (Optimized with Performance and UI Improvements) --- */
        :root {
            --primary-bg: #0F172A;
            --secondary-bg: #1E293B;
            --card-bg: #1E293B;
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --accent-color: #FACC15;
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6;
            --border-color: #334155;
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --info-color: #3B82F6;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        html { 
            font-size: 16px; 
            scroll-behavior: smooth;
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--primary-bg); 
            color: var(--text-primary); 
            padding-top: 70px; 
            padding-bottom: 75px; 
            min-height: 100vh; 
            overscroll-behavior-y: contain; 
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        a { 
            color: var(--accent-color); 
            text-decoration: none; 
        } 
        
        a:hover { 
            color: #FBBF24; 
        }
        
        .main-content { 
            padding: 15px; 
            max-width: 100%;
            overflow-x: hidden;
        } 
        
        .section { 
            display: none; 
            animation: fadeIn 0.3s ease-in-out; 
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        } 
        
        .section.active { 
            display: block; 
        } 
        
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        .section-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-bottom: 15px; 
            color: var(--text-primary); 
            text-shadow: var(--shadow-sm);
        } 
        
        .custom-card { 
            background-color: var(--card-bg); 
            border-radius: 10px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color); 
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        } 
        
        .custom-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .btn-custom { 
            border-radius: 6px; 
            font-size: 0.9rem; 
            font-weight: 500; 
            padding: 8px 15px; 
            border: none; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
            transition: background-color 0.2s ease, filter 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; 
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        } 
        
        .btn-custom:active {
            transform: scale(0.98);
        }
        
        .btn-custom-primary { 
            background-color: var(--primary-button-bg); 
            color: var(--text-primary); 
        } 
        
        .btn-custom-primary:hover { 
            background-color: #2563EB; 
            box-shadow: var(--shadow-md);
        } 
        
        .btn-custom-secondary { 
            background-color: var(--secondary-bg); 
            color: var(--text-primary); 
            border: 1px solid var(--border-color); 
        } 
        
        .btn-custom-secondary:hover { 
            background-color: #334155; 
            box-shadow: var(--shadow-md);
        } 
        
        .btn-custom-accent { 
            background: var(--accent-gradient); 
            color: var(--primary-bg); 
            font-weight: 600; 
        } 
        
        .btn-custom-accent:hover { 
            filter: brightness(1.1); 
            box-shadow: var(--shadow-md);
        } 
        
        .btn-custom-link { 
            background: none; 
            border: none; 
            color: var(--primary-button-bg); 
            font-size: 0.9rem; 
            font-weight: 500; 
            padding: 0; 
            cursor: pointer; 
            box-shadow: none;
        } 
        
        .btn-custom-link:hover {
            text-decoration: underline;
            box-shadow: none;
            transform: none;
        }
        
        .text-accent { 
            color: var(--accent-color); 
        } 
        
        .text-success { 
            color: var(--success-color); 
        } 
        
        .text-danger { 
            color: var(--danger-color); 
        } 
        
        .text-warning { 
            color: var(--warning-color); 
        }
        
        .form-control { 
            background-color: var(--primary-bg); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: 6px; 
            box-shadow: var(--shadow-sm);
        } 
        
        .form-control:focus { 
            background-color: var(--primary-bg); 
            border-color: var(--accent-color); 
            color: var(--text-primary); 
            box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); 
        } 
        
        .form-control::placeholder { 
            color: var(--text-secondary); 
            opacity: 0.7; 
        } 
        
        .form-label { 
            color: var(--text-secondary); 
            font-size: 0.9rem; 
        } 
        
        .alert { 
            border-radius: 6px; 
            font-size: 0.9rem; 
            box-shadow: var(--shadow-sm);
        } 
        
        .list-group-item { 
            background-color: var(--card-bg); 
            color: var(--text-primary); 
            border: none; 
            border-bottom: 1px solid var(--border-color); 
            padding: 15px; 
            font-size: 0.95rem; 
            transition: background-color 0.2s ease; 
        } 
        
        .list-group-item:hover { 
            background-color: rgba(255, 255, 255, 0.05); 
        } 
        
        .list-group-item:last-child { 
            border-bottom: none; 
        } 
        
        .list-group-item i:first-child { 
            color: var(--accent-color); 
            margin-right: 15px; 
            font-size: 1.1rem; 
            width: 20px; 
            text-align: center; 
        } 
        
        .list-group-item .bi-chevron-right { 
            color: var(--text-secondary); 
            font-size: 0.9rem; 
        } 
        
        #globalLoaderEl { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            display: none; 
        } 
        
        .spinner-border { 
            color: var(--accent-color); 
            width: 3rem; 
            height: 3rem; 
        } 
        
        .placeholder-glow .placeholder { 
            background-color: rgba(51, 65, 85, 0.5); 
            animation: placeholder-glow 2s ease-in-out infinite; 
        } 
        
        .placeholder { 
            background-color: rgba(51, 65, 85, 0.5); 
            border-radius: 4px; 
        } 
        
        @keyframes placeholder-glow { 
            0% { 
                background-color: rgba(51, 65, 85, 0.5); 
            } 
            50% { 
                background-color: rgba(51, 65, 85, 0.7); 
            } 
            100% { 
                background-color: rgba(51, 65, 85, 0.5); 
            } 
        } 
        
        .interactive-list-item { 
            cursor: pointer; 
        } 
        
        .referral-code { 
            font-family: monospace; 
            letter-spacing: 1px; 
            user-select: all; 
        } 
        
        .app-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 60px; 
            background-color: var(--secondary-bg); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 15px; 
            box-shadow: var(--shadow-lg);
            z-index: 1000; 
            border-bottom: 1px solid var(--border-color); 
        } 
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex: 1;
            min-width: 0;
        } 
        
        .header-logo { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background-color: #fff; 
            object-fit: cover; 
            border: 1px solid var(--accent-color); 
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        } 
        
        .header-title { 
            font-size: 0.9rem; 
            font-weight: 500; 
            line-height: 1.2; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        } 
        
        .header-title span { 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
            display: block; 
        } 
        
        .header-back-button { 
            background: none; 
            border: none; 
            color: var(--text-primary); 
            font-size: 1.4rem; 
            margin-right: 5px; 
            display: none; 
            padding: 5px; 
            flex-shrink: 0;
            cursor: pointer;
            transition: color 0.2s ease;
        } 
        
        .header-back-button:hover {
            color: var(--accent-color);
        }
        
        .header-right { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-shrink: 0;
        } 
        
        .notification-icon { 
            font-size: 1.3rem; 
            color: var(--text-primary); 
            position: relative; 
            background: none; 
            border: none; 
            padding: 0; 
            flex-shrink: 0;
            cursor: pointer;
            transition: color 0.2s ease;
        } 
        
        .notification-icon:hover {
            color: var(--accent-color);
        }
        
        .notification-badge { 
            position: absolute; 
            top: -3px; 
            right: -5px; 
            background-color: var(--danger-color); 
            color: white; 
            font-size: 0.6rem; 
            width: 15px; 
            height: 15px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: bold; 
            box-shadow: var(--shadow-sm);
        } 
        
        .wallet-chip { 
            background: var(--accent-gradient); 
            color: var(--primary-bg); 
            padding: 5px 12px; 
            border-radius: 20px; 
            display: flex; 
            align-items: center; 
            font-size: 0.85rem; 
            font-weight: 700; 
            border: none; 
            box-shadow: var(--shadow-md);
            cursor: pointer; 
            flex-shrink: 0;
            transition: transform 0.1s ease;
        } 
        
        .wallet-chip:active {
            transform: scale(0.95);
        }
        
        .wallet-chip i { 
            margin-right: 5px; 
            font-size: 0.9rem; 
        } 
        
        .header-game-title { 
            font-size: 1rem; 
            font-weight: 600; 
            color: var(--text-primary); 
            margin-left: 10px; 
            display: none; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        } 
        
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 65px; 
            background-color: var(--bottom-nav-bg); 
            display: flex; 
            justify-content: space-around; 
            align-items: stretch; 
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1000; 
            border-top: 1px solid var(--border-color); 
        } 
        
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-secondary); 
            text-decoration: none; 
            flex-grow: 1; 
            padding: 8px 0; 
            transition: color 0.2s ease, background-color 0.2s ease; 
            border: none; 
            background: none; 
            cursor: pointer; 
            font-size: 0.7rem; 
            min-width: 0;
        } 
        
        .nav-item i { 
            font-size: 1.4rem; 
            margin-bottom: 4px; 
            line-height: 1; 
            transition: transform 0.2s ease;
        } 
        
        .nav-item span { 
            font-size: 0.7rem; 
            font-weight: 500; 
            line-height: 1; 
        } 
        
        .nav-item.active { 
            color: var(--accent-color); 
            background-color: rgba(250, 204, 21, 0.1); 
        }
        
        .nav-item.active i {
            transform: scale(1.1);
        }
        
        /* Fixed Promotion Slider */
        .promotion-slider-container {
            width: 100%;
            margin-bottom: 25px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-md);
        }
        
        .swiper-container { 
            width: 100%; 
            height: 180px; 
            border-radius: 10px; 
            --swiper-pagination-color: var(--accent-color); 
            --swiper-pagination-bullet-inactive-color: var(--text-secondary); 
            --swiper-pagination-bullet-size: 8px; 
        } 
        
        .swiper-slide { 
            background-color: var(--secondary-bg); 
            border-radius: 10px; 
            overflow: hidden;
        } 
        
        .swiper-slide img { 
            display: block; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border-radius: 10px; 
        } 
        
        .game-card { 
            text-align: center; 
            background-color: var(--card-bg); 
            border-radius: 8px; 
            overflow: hidden; 
            padding: 0; 
            border: 1px solid var(--border-color); 
            cursor: pointer; 
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-sm);
        } 
        
        .game-card:hover { 
            transform: translateY(-3px); 
            box-shadow: var(--shadow-lg);
        } 
        
        .game-card img { 
            width: 100%; 
            height: 130px; 
            object-fit: cover; 
            display: block; 
            flex-shrink: 0;
        } 
        
        .game-card span { 
            display: block; 
            padding: 10px 5px; 
            font-weight: 500; 
            font-size: 0.9rem; 
            color: var(--text-primary); 
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        } 
        
        .tournament-tabs { 
            display: flex; 
            justify-content: space-around; 
            background-color: var(--secondary-bg); 
            padding: 5px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            width: 100%;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        } 
        
        .tab-item { 
            color: var(--text-secondary); 
            background: none; 
            border: none; 
            padding: 8px 10px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            border-radius: 6px; 
            flex-grow: 1; 
            text-align: center; 
            cursor: pointer; 
            transition: background-color 0.2s, color 0.2s; 
            white-space: nowrap;
            min-width: 0;
        } 
        
        .tab-item.active { 
            background-color: var(--primary-button-bg); 
            color: var(--text-primary); 
            box-shadow: var(--shadow-sm);
        } 
        
        .tab-item i { 
            margin-right: 5px; 
        } 
        
        .tournament-card { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            margin-bottom: 15px; 
            padding: 15px; 
            border: 1px solid var(--border-color); 
            width: 100%;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        } 
        
        .tournament-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .tournament-card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 10px; 
            flex-wrap: wrap; 
            gap: 5px; 
            width: 100%;
        } 
        
        .tournament-card-tags { 
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            flex: 1;
        }
        
        .tournament-card-tags span { 
            background-color: var(--primary-bg); 
            color: var(--text-secondary); 
            font-size: 0.7rem; 
            font-weight: 500; 
            padding: 3px 8px; 
            border-radius: 4px; 
            display: inline-block; 
            border: 1px solid var(--border-color); 
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        } 
        
        .tournament-card-timer { 
            background-color: rgba(255, 255, 255, 0.1); 
            color: var(--text-primary); 
            font-size: 0.75rem; 
            font-weight: 600; 
            padding: 3px 8px; 
            border-radius: 4px; 
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        } 
        
        .tournament-card-title { 
            font-size: 1rem; 
            font-weight: 600; 
            margin-bottom: 5px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            color: var(--text-primary); 
            width: 100%;
        } 
        
        .tournament-card-title i { 
            color: var(--accent-color); 
            flex-shrink: 0;
        } 
        
        .tournament-card-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: stretch; 
            border-top: 1px dashed var(--border-color); 
            border-bottom: 1px dashed var(--border-color); 
            padding: 10px 0; 
            margin: 10px 0; 
            font-size: 0.8rem; 
            width: 100%;
        } 
        
        .info-item { 
            text-align: center; 
            flex: 1; 
            padding: 0 5px; 
            min-width: 0;
        } 
        
        .info-item span { 
            display: block; 
            color: var(--text-secondary); 
            font-size: 0.7rem; 
            margin-bottom: 2px; 
            white-space: nowrap;
        } 
        
        .info-item strong { 
            color: var(--text-primary); 
            font-weight: 600; 
            font-size: 0.9rem; 
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        } 
        
        .info-item .prize-icon { 
            color: var(--accent-color); 
            font-size: 1.2rem; 
        } 
        
        .tournament-card-spots { 
            font-size: 0.8rem; 
            color: var(--text-secondary); 
            margin-bottom: 15px; 
            width: 100%;
        } 
        
        .tournament-card-spots span { 
            font-weight: 600; 
        } 
        
        .progress { 
            height: 6px; 
            background-color: var(--primary-bg); 
            border-radius: 3px; 
            overflow: hidden; 
            width: 100%;
            box-shadow: var(--shadow-sm);
        } 
        
        .progress-bar { 
            background-color: var(--warning-color); 
            transition: width 0.3s ease; 
        } 
        
        .tournament-card-actions { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 10px; 
            width: 100%;
        } 
        
        .tournament-card-actions .btn-sm { 
            padding: 8px 10px; 
            font-size: 0.85rem; 
            width: 100%; 
            min-width: 0;
        } 
        
        .tournament-card-actions .btn-join { 
            background: var(--accent-gradient); 
            color: var(--primary-bg); 
            font-weight: 600; 
            grid-column: 2 / 3; 
        } 
        
        .tournament-card-actions .btn-details { 
            background-color: var(--secondary-bg); 
            border: 1px solid var(--border-color); 
            grid-column: 1 / 2; 
        } 
        
        .tournament-card-actions .btn-joined { 
            background-color: var(--success-color); 
            color: var(--text-primary); 
            opacity: 0.8; 
            grid-column: 2 / 3; 
        } 
        
        .tournament-card-actions .btn-disabled { 
            background-color: var(--secondary-bg); 
            opacity: 0.6; 
            cursor: not-allowed; 
            grid-column: 2 / 3; 
        } 
        
        .btn-idpass { 
            background: var(--accent-gradient); 
            color: var(--primary-bg); 
            border: none; 
            font-weight: 600; 
            width: 100%;
        } 
        
        .wallet-card { 
            background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); 
            border-radius: 10px; 
            padding: 20px; 
            border: 1px solid var(--border-color); 
            width: 100%;
            box-shadow: var(--shadow-lg);
        } 
        
        .wallet-card h2 { 
            font-size: 1.2rem; 
            font-weight: 600; 
            margin-bottom: 25px; 
        } 
        
        .balance-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 1px dashed var(--border-color); 
            width: 100%;
        } 
        
        .balance-item:last-child { 
            margin-bottom: 0; 
            border-bottom: none; 
            padding-bottom: 0; 
        } 
        
        .balance-item-label { 
            font-size: 0.95rem; 
            color: var(--text-secondary); 
            flex: 1;
        } 
        
        .balance-item-value { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin: 0 10px;
            min-width: 80px;
            text-align: right;
        } 
        
        .balance-item-action { 
            min-width: 100px; 
            text-align: right; 
            flex-shrink: 0;
        } 
        
        .balance-item-action .btn-custom-link { 
            font-size: 0.85rem; 
            color: var(--accent-color); 
            padding: 5px; 
        } 
        
        .balance-item-action .btn-withdraw { 
            background-color: var(--primary-button-bg); 
            color: #fff; 
            font-size: 0.8rem; 
            padding: 5px 12px; 
            border-radius: 5px; 
            border: none; 
            box-shadow: var(--shadow-sm);
        } 
        
        #recentTransactionsListEl .custom-card { 
            background-color: var(--secondary-bg); 
        } 
        
        #earnings-section .custom-card { 
            text-align: center; 
            width: 100%;
        } 
        
        #earnings-section .display-4 { 
            font-size: 3rem; 
        } 
        
        #earnings-section p strong { 
            color: var(--text-primary); 
        } 
        
        .profile-header-card { 
            background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); 
            border-radius: 10px; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            margin-bottom: 20px; 
            border: 1px solid var(--border-color); 
            width: 100%;
            position: relative;
            box-shadow: var(--shadow-lg);
        } 
        
        .profile-avatar { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            margin-bottom: 10px; 
            border: 2px solid var(--accent-color); 
            object-fit: cover; 
            background-color: var(--primary-bg); 
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
        } 
        
        .profile-name { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-bottom: 2px; 
            width: 100%;
        } 
        
        .profile-email { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            margin-bottom: 15px; 
            word-break: break-all; 
            width: 100%;
        } 
        
        .profile-stats { 
            display: flex; 
            justify-content: space-around; 
            width: 100%; 
            border-top: 1px solid var(--border-color); 
            padding-top: 15px; 
        } 
        
        .stat-item { 
            text-align: center; 
            flex: 1; 
            min-width: 0;
        } 
        
        .stat-item strong { 
            display: block; 
            font-size: 1rem; 
            font-weight: 600; 
        } 
        
        .stat-item span { 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
        } 
        
        .profile-links .list-group { 
            border-radius: 10px; 
            overflow: hidden; 
            border: 1px solid var(--border-color); 
            width: 100%;
            box-shadow: var(--shadow-md);
        } 
        
        .profile-links .form-switch .form-check-input { 
            background-color: var(--secondary-bg); 
            border-color: var(--border-color); 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e"); 
        } 
        
        .profile-links .form-switch .form-check-input:checked { 
            background-color: var(--accent-color); 
            border-color: var(--accent-color); 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e"); 
        } 
        
        #login-section { 
            margin-top: 5vh; 
        } 
        
        #login-section .card { 
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color); 
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            box-shadow: var(--shadow-lg);
        } 
        
        #login-section .btn-primary { 
            background-color: var(--primary-button-bg); 
            border: none; 
        } 
        
        #login-section .btn-link { 
            background: none; 
            border: none; 
            color: var(--accent-color); 
            text-decoration: none; 
            font-size: 0.9em; 
            padding: 5px 0; 
        } 
        
        #login-section .btn-link:hover { 
            text-decoration: underline; 
        } 
        
        #login-section .btn-success { 
            background-color: var(--success-color); 
            border: none; 
        } 
        
        #login-section .btn-danger { 
            background-color: var(--danger-color); 
            border: none; 
        } 
        
        #login-section .form-divider { 
            text-align: center; 
            margin: 20px 0; 
            position: relative; 
            color: var(--text-secondary); 
        } 
        
        #login-section .form-divider::before, #login-section .form-divider::after { 
            content: ""; 
            position: absolute; 
            top: 50%; 
            width: 40%; 
            height: 1px; 
            background-color: var(--border-color); 
        } 
        
        #login-section .form-divider::before { 
            left: 0; 
        } 
        
        #login-section .form-divider::after { 
            right: 0; 
        } 
        
        #login-section .form-divider span { 
            background-color: var(--card-bg); 
            padding: 0 10px; 
            position: relative; 
            z-index: 1; 
            font-size: 0.8rem; 
            font-weight: 500; 
        } 
        
        #login-section .card-title { 
            color: var(--text-primary); 
        } 
        
        #googleSignInBtnMainEl { 
            display: none; 
        } 
        
        .modal-content { 
            background-color: var(--secondary-bg); 
            color: var(--text-primary); 
            border: 1px solid var(--border-color); 
            max-width: 100%;
            box-shadow: var(--shadow-lg);
        } 
        
        .modal-header { 
            border-bottom-color: var(--border-color); 
        } 
        
        .modal-footer { 
            border-top-color: var(--border-color); 
        } 
        
        .btn-close-white { 
            filter: invert(1) grayscale(100%) brightness(200%); 
        } 
        
        .modal-body .phonepe-number { 
            color: var(--warning-color); 
            font-weight: bold; 
            user-select: text; 
        } 
        
        #matchDetailsModalBodyEl pre { 
            background-color: var(--primary-bg); 
            padding: 10px; 
            border-radius: 5px; 
            border: 1px solid var(--border-color); 
            color: var(--text-secondary); 
            font-size: 0.85rem; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            max-width: 100%;
            overflow-x: auto;
            box-shadow: var(--shadow-sm);
        } 
        
        #policyModalBodyEl { 
            line-height: 1.6; 
            font-size: 0.95rem; 
            white-space: pre-wrap; 
            max-width: 100%;
            overflow-x: hidden;
        } 
        
        #idPasswordModalEl .copy-btn { 
            padding: 2px 6px; 
            font-size: 0.8rem; 
            margin-left: 8px; 
            vertical-align: middle; 
        } 
        
        #policyModalBodyEl .copy-btn, #policyModalBodyEl #shareReferralBtn { 
            padding: 4px 10px; 
            font-size: 0.9rem; 
        } 
        
        #policyModalBodyEl #shareReferralBtn i, #policyModalBodyEl .copy-btn i { 
            margin-right: 5px; 
        } 
        
        #securityWarning { 
            background-color: var(--danger-color); 
            color: white; 
            padding: 10px 15px; 
            text-align: center; 
            font-size: 0.9rem; 
            position: sticky; 
            top: 60px; 
            z-index: 999; 
            border-bottom: 1px solid #a51d1d; 
            width: 100%;
            box-shadow: var(--shadow-md);
        } 
        
        #securityWarning a { 
            color: #ffdddd; 
            text-decoration: underline; 
        } 
        
        #securityWarning button { 
            background: none; 
            border: 1px solid white; 
            color: white; 
            padding: 2px 8px; 
            margin-left: 15px; 
            font-size: 0.8rem; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        
        /* New styles for edit profile */
        .edit-profile-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }
        
        .edit-profile-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--accent-color);
            transform: scale(1.05);
        }
        
        /* Stats improvement */
        .stat-item strong {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .stat-item span {
            font-size: 0.8rem;
        }
        
        /* QR Code Styles */
        .qr-code-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: var(--primary-bg);
            border-radius: 10px;
            width: 100%;
            box-shadow: var(--shadow-md);
        }
        
        .qr-code-image {
            max-width: 200px;
            height: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin: 0 auto;
            box-shadow: var(--shadow-sm);
        }
        
        .payment-instructions {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
            width: 100%;
        }
        
        /* Data refresh improvements */
        .refresh-btn {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: rotate(90deg);
        }
        
        .refresh-btn:active {
            transform: rotate(180deg);
        }
        
        /* Tournament Winner Styles */
        .tournament-winner {
            background: linear-gradient(145deg, var(--primary-bg), var(--secondary-bg));
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid var(--accent-color);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-md);
        }
        
        .tournament-winner-icon {
            color: var(--accent-color);
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .tournament-winner-details {
            flex: 1;
        }
        
        .tournament-winner-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--accent-color);
        }
        
        .tournament-winner-prize {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Fix for small screens */
        @media (max-width: 576px) {
            .main-content {
                padding: 10px;
            }
            
            .swiper-container {
                height: 160px;
            }
            
            .game-card span {
                font-size: 0.8rem;
                padding: 8px 3px;
            }
            
            .tournament-card {
                padding: 12px;
            }
            
            .tournament-card-title {
                font-size: 0.95rem;
            }
            
            .info-item strong {
                font-size: 0.85rem;
            }
            
            .wallet-card {
                padding: 15px;
            }
        }
        
        @media (max-width: 400px) {
            .header-title {
                font-size: 0.8rem;
            }
            
            .header-title span {
                font-size: 0.7rem;
            }
            
            .wallet-chip {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            .tournament-tabs {
                padding: 3px;
            }
            
            .tab-item {
                padding: 6px 5px;
                font-size: 0.75rem;
            }
            
            .tab-item i {
                margin-right: 3px;
            }
        }
        
        /* Ensure no horizontal scrolling */
        body, html {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding-left: 15px;
            padding-right: 15px;
        }
        
        .row {
            margin-left: -8px;
            margin-right: -8px;
        }
        
        .row > * {
            padding-left: 8px;
            padding-right: 8px;
        }
        
        /* Performance optimizations */
        .lazy-load {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .lazy-loaded {
            opacity: 1;
        }
        
        /* Add winning amount display in profile */
        .winning-amount {
            color: var(--success-color);
            font-weight: 600;
        }
        
        /* Optimize animations */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>

<body>
     <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo" id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> Welcome <span id="headerUserGreetingEl">Guest</span> </div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i class="bi bi-wallet-fill"></i> â‚¹<span id="headerChipBalanceEl">0</span> </button>
            <button class="refresh-btn" id="refreshDataBtnEl" title="Refresh Data"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl"> <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> </div>

        <!-- Login Section -->
        <section id="login-section" class="section active">
             <div class="container">
                <div class="card shadow-sm custom-card">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="loginEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label> <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required> </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">Forgot Password?</a> </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center mb-4">Sign Up</h2>
                            <!-- Name Field Added -->
                            <div class="mb-3"> <label for="signupNameInputEl" class="form-label">Full Name</label> <input type="text" class="form-control" id="signupNameInputEl" placeholder="Your Name" required> </div>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label> <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Password" required minlength="6"> </div>
                            <div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label> <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required> </div>
                            <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">Already have account? Login</button> </div>
                        </form>

                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- Promotion Slider - Fixed -->
            <div class="promotion-slider-container">
                <div class="swiper-container" id="promotionSliderEl">
                    <div class="swiper-wrapper placeholder-glow">
                        <div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>
                     </div>
                     <div class="swiper-pagination"></div>
                </div>
            </div>

            <!-- Esport Games -->
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <!-- Placeholder Game Cards -->
                <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div> 
                <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
            </div>

            <!-- My Contests -->
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                 <!-- Placeholder Contest Card -->
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> 
                <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event-fill"></i> Upcoming</button> 
                <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> 
                <button class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> 
            </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow"> 
                <div class="tournament-card placeholder-glow mb-3"> 
                    <span class="placeholder col-6" style="height: 18px;"></span> 
                    <span class="placeholder col-12 mt-2" style="height: 24px;"></span> 
                    <span class="placeholder col-10 mt-2" style="height: 16px;"></span> 
                    <div class="d-flex justify-content-between mt-3"> 
                        <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> 
                        <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> 
                    </div> 
                </div> 
            </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Total Balance</span> <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Winning Cash</span> <span class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action"> <button class="btn-withdraw" id="withdrawBtnEl">Withdraw</button> </div> </div>
                <div class="balance-item placeholder-glow"> <span class="balance-item-label">Bonus Cash</span> <span class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span> <div class="balance-item-action" style="min-width: 100px;"></div> </div>
                <button class="btn btn-custom btn-custom-secondary w-100 mt-4" id="addAmountWalletBtnEl"> <i class="bi bi-plus-circle-fill me-2"></i>Add Amount </button>
            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow"> 
                <div class="custom-card p-2 mb-2 placeholder-glow"> 
                    <div class="d-flex justify-content-between"> 
                        <span class="placeholder col-5" style="height: 16px;"></span> 
                        <span class="placeholder col-3" style="height: 16px;"></span> 
                    </div> 
                    <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> 
                </div> 
                <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p> 
            </div>
        </section>

        <!-- Earnings Section -->
        <section id="earnings-section" class="section">
            <h2 class="section-title">Earnings</h2>
            <div class="custom-card text-center">
                <i class="bi bi-coin display-4 text-accent mb-3"></i>
                <p class="text-secondary mb-4">Track your earnings from tournaments and referrals here.</p>
                <div class="placeholder-glow"> <p>Total Earned: <strong id="earningsTotalEl"><span class="placeholder col-3"></span></strong></p> <p>From Referrals: <strong id="earningsReferralEl"><span class="placeholder col-3"></span></strong></p> </div>
                <button class="btn btn-custom btn-custom-link mt-3" id="viewEarningsHistoryBtn">View History</button>
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow" style="position: relative;">
                <button class="edit-profile-btn" id="editProfileBtnEl"><i class="bi bi-pencil-fill"></i></button>
                <img src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl"> 
                <h3 class="profile-name mt-2" id="profileNameEl"><span class="placeholder col-6"></span></h3> 
                <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p> 
                <div class="profile-stats w-100"> 
                    <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div> 
                    <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div> 
                    <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div> 
                </div> 
                <!-- Add Winning Amount Display -->
                <div class="mt-3 p-3 w-100" style="background: var(--primary-bg); border-radius: 8px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-secondary">Winning Amount:</span>
                        <span class="winning-amount" id="profileWinningAmountEl"><span class="placeholder col-3"></span></span>
                    </div>
                </div>
            </div>
            <div class="profile-links">
                <div class="list-group custom-card">
                    <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"> <span><i class="bi bi-bell-fill"></i> Notifications</span> <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked> </div> </label>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i class="bi bi-chevron-right"></i> </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i class="bi bi-chevron-right"></i> </a>
                    <button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span> </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div>
    
    <!-- Add Amount Modal - Fixed with QR Code -->
    <div class="modal fade" id="addAmountModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i> Add Money to Wallet</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="payment-instructions">To add money to your wallet, please scan the QR code below or use the UPI ID:</p>
                    
                    <!-- QR Code Section -->
                    <div class="qr-code-container">
                        <div id="qrCodeImageContainer">
                            <img id="qrCodeImageEl" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=YOUR_UPI_ID&pn=Gaming%20Tournament&am=&cu=INR" alt="QR Code for UPI Payment" class="qr-code-image">
                        </div>
                        <p class="mt-3"><strong>UPI ID:</strong> <span class="phonepe-number" id="upiIdDisplay">[!!! YOUR UPI ID/NUMBER HERE !!!]</span></p>
                    </div>
                    
                    <div class="payment-instructions">
                        <p><strong><i class="bi bi-exclamation-triangle-fill text-warning"></i> IMPORTANT:</strong></p>
                        <ol class="small">
                            <li>Scan the QR code or send money to the UPI ID above</li>
                            <li>After payment, contact admin via <span id="adminContactDisplay">[!!! ADMIN CONTACT INFO HERE !!!]</span></li>
                            <li>Provide your registered email (<strong id="modalUserEmailEl">...</strong>) and payment screenshot</li>
                            <li>Amount will be added manually after verification</li>
                        </ol>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="copyUpiIdBtnEl">Copy UPI ID</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="withdrawModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">â‚¹0.00</strong></p><div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min â‚¹<span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount"></div><div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">Withdrawal Method (UPI/Bank)</label><input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="Enter UPI ID / Bank Details"></div><div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button></div></div></div></div>
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="matchDetailsModalBodyEl"></div></div></div></div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Room ID & Password</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-secondary">ID/Pass shown shortly before match start.</p><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Room ID:</p><h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button></div><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Password:</p><h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password"><i class="bi bi-clipboard"></i></button></div><p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.</p></div></div></div></div>
    
    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-fill me-2"></i> Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 text-center">
                        <img src="https://via.placeholder.com/80" alt="Avatar" class="profile-avatar mb-2" id="editProfileAvatarEl" style="width: 80px; height: 80px;">
                        <button class="btn btn-sm btn-custom btn-custom-secondary" id="changeAvatarBtnEl">Change Photo</button>
                    </div>
                    <div class="mb-3">
                        <label for="editProfileNameInputEl" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editProfileNameInputEl" placeholder="Your Name">
                    </div>
                    <div class="mb-3">
                        <label for="editProfileEmailInputEl" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editProfileEmailInputEl" placeholder="Email" readonly>
                        <div class="form-text text-secondary">Email cannot be changed</div>
                    </div>
                    <div class="mb-3">
                        <label for="editProfilePhoneInputEl" class="form-label">Phone Number (Optional)</label>
                        <input type="tel" class="form-control" id="editProfilePhoneInputEl" placeholder="Phone Number">
                    </div>
                    <div id="editProfileStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="saveProfileBtnEl">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="tournaments-section"><i class="bi bi-trophy-fill"></i><span>Tournaments</span></button>
        <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_B6ZduTIjfxoPSDHajSPGQXANuf9VByk",
            authDomain: "tornament-4aa26.firebaseapp.com",
            databaseURL: "https://tornament-4aa26-default-rtdb.firebaseio.com",
            projectId: "tornament-4aa26",
            storageBucket: "tornament-4aa26.firebasestorage.app",
            messagingSenderId: "462695574159",
            appId: "1:462695574159:web:329d610d5c72dba2091efa"
        };

        // Initialize Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Could not connect. Check Firebase config & console. Error: ${error.message}</div>`;
        }

        // --- DOM Elements Cache ---
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        
        const elements = {
            sections: querySelAll('.section'), 
            bottomNavItems: querySelAll('.bottom-nav .nav-item'), 
            globalLoader: getElement('globalLoaderEl'),
            headerBackBtn: getElement('headerBackBtnEl'), 
            headerTitleContainer: getElement('headerTitleContainerEl'), 
            headerGameTitle: getElement('headerGameTitleEl'), 
            headerWalletChip: getElement('headerWalletChipEl'), 
            headerChipBalance: getElement('headerChipBalanceEl'), 
            headerUserGreeting: getElement('headerUserGreetingEl'), 
            appLogo: getElement('appLogoEl'), 
            notificationBtn: getElement('notificationBtnEl'), 
            notificationBadge: querySel('.notification-badge'),
            loginSection: getElement('login-section'),
            emailLoginForm: getElement('emailLoginForm'),
            loginEmailInput: getElement('loginEmailInputEl'),
            loginPasswordInput: getElement('loginPasswordInputEl'),
            loginEmailBtn: getElement('loginEmailBtnEl'),
            showSignupToggleBtn: getElement('showSignupToggleBtnEl'),
            loginStatusMessage: getElement('loginStatusMessageEl'),
            forgotPasswordLink: getElement('forgotPasswordLinkEl'),
            emailSignupForm: getElement('emailSignupForm'),
            signupNameInput: getElement('signupNameInputEl'),
            signupEmailInput: getElement('signupEmailInputEl'),
            signupPasswordInput: getElement('signupPasswordInputEl'),
            signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'),
            signupReferralCodeInput: getElement('signupReferralCodeInputEl'),
            signupEmailBtn: getElement('signupEmailBtnEl'),
            showLoginToggleBtn: getElement('showLoginToggleBtnEl'),
            signupStatusMessage: getElement('signupStatusMessageEl'),
            homeSection: getElement('home-section'), 
            promotionSlider: getElement('promotionSliderEl'), 
            gamesList: getElement('gamesListEl'), 
            myContestsList: getElement('myContestsListEl'), 
            noContestsMessage: getElement('noContestsMessageEl'),
            tournamentsSection: getElement('tournaments-section'), 
            tournamentsListContainer: getElement('tournamentsListContainerEl'), 
            noTournamentsMessage: getElement('noTournamentsMessageEl'), 
            tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
            walletSection: getElement('wallet-section'), 
            walletTotalBalance: getElement('walletTotalBalanceEl'), 
            walletWinningCash: getElement('walletWinningCashEl'), 
            walletBonusCash: getElement('walletBonusCashEl'), 
            allTransactionsBtn: getElement('allTransactionsBtnEl'), 
            withdrawBtn: getElement('withdrawBtnEl'), 
            addAmountWalletBtn: getElement('addAmountWalletBtnEl'), 
            recentTransactionsList: getElement('recentTransactionsListEl'), 
            noTransactionsMessage: getElement('noTransactionsMessageEl'),
            earningsSection: getElement('earnings-section'), 
            earningsTotal: getElement('earningsTotalEl'), 
            earningsReferral: getElement('earningsReferralEl'), 
            viewEarningsHistoryBtn: getElement('viewEarningsHistoryBtn'),
            profileSection: getElement('profile-section'), 
            profileAvatar: getElement('profileAvatarEl'), 
            profileName: getElement('profileNameEl'), 
            profileEmail: getElement('profileEmailEl'), 
            profileTotalMatches: getElement('profileTotalMatchesEl'), 
            profileWonMatches: getElement('profileWonMatchesEl'), 
            profileTotalEarnings: getElement('profileTotalEarningsEl'), 
            profileWinningAmount: getElement('profileWinningAmountEl'), // NEW: Winning amount in profile
            logoutProfileBtn: getElement('logoutProfileBtnEl'), 
            editProfileBtn: getElement('editProfileBtnEl'),
            policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), 
            notificationSwitch: getElement('notificationSwitchEl'),
            policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, 
            policyModalTitle: getElement('policyModalTitleEl'), 
            policyModalBody: getElement('policyModalBodyEl'),
            addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, 
            modalUserEmail: getElement('modalUserEmailEl'),
            withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, 
            withdrawModalBalance: getElement('withdrawModalBalanceEl'), 
            withdrawAmountInput: getElement('withdrawAmountInputEl'), 
            withdrawMethodInput: getElement('withdrawMethodInputEl'), 
            minWithdrawAmount: getElement('minWithdrawAmountEl'), 
            withdrawStatusMessage: getElement('withdrawStatusMessageEl'), 
            submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
            matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, 
            matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), 
            matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
            idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, 
            roomIdDisplay: getElement('roomIdDisplayEl'), 
            roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
            editProfileModalInstance: getElement('editProfileModalEl') ? new bootstrap.Modal(getElement('editProfileModalEl')) : null,
            editProfileAvatar: getElement('editProfileAvatarEl'),
            editProfileNameInput: getElement('editProfileNameInputEl'),
            editProfileEmailInput: getElement('editProfileEmailInputEl'),
            editProfilePhoneInput: getElement('editProfilePhoneInputEl'),
            editProfileStatusMessage: getElement('editProfileStatusMessageEl'),
            saveProfileBtn: getElement('saveProfileBtnEl'),
            changeAvatarBtn: getElement('changeAvatarBtnEl'),
            securityWarning: getElement('securityWarning'),
            qrCodeImage: getElement('qrCodeImageEl'),
            upiIdDisplay: getElement('upiIdDisplay'),
            adminContactDisplay: getElement('adminContactDisplay'),
            copyUpiIdBtn: getElement('copyUpiIdBtnEl'),
            refreshDataBtn: getElement('refreshDataBtnEl')
        };

        // --- App State ---
        let currentUser = null;
        let userProfile = {};
        let currentSectionId = 'login-section';
        let dbListeners = {};
        let swiperInstance;
        let currentTournamentGameId = null;
        let appSettings = {};
        let validReferrerUid = null;
        
        // Performance optimization - Debounce function
        function debounce(func, wait, immediate) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        }

        // --- Utility Functions ---
        const showLoader = (show) => {
            if (elements.globalLoader) {
                elements.globalLoader.style.display = show ? 'flex' : 'none';
            }
        };

        function showStatusMessage(element, message, type = 'danger', autohide = true) {
            if (!element) return;
            element.innerHTML = message;
            element.className = `alert alert-${type} mt-3`;
            element.style.display = 'block';
            element.setAttribute('role', 'alert');
            if (autohide) {
                setTimeout(() => {
                    if (element.innerHTML === message) {
                        element.style.display = 'none';
                    }
                }, 5000);
            }
        }

        function clearStatusMessage(element) {
            if (!element) return;
            element.style.display = 'none';
            element.innerHTML = '';
            element.removeAttribute('role');
        }

        function copyToClipboard(targetSelector) {
            if (!targetSelector) {
                alert('Copy target not defined.');
                return;
            }
            const targetElement = querySel(targetSelector);
            if (!targetElement) {
                alert('Element to copy from not found.');
                return;
            }
            const textToCopy = targetElement.textContent;
            if (!textToCopy || textToCopy === 'N/A' || textToCopy.includes('placeholder')) {
                alert('Nothing to copy.');
                return;
            }
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('Copied!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy.');
            });
        }

        function shareReferral(code) {
            if (!navigator.share) {
                alert('Web Share not supported. Copy the code manually.');
                return;
            }
            if (!code || code === 'N/A') {
                alert('Referral code not available.');
                return;
            }
            navigator.share({
                title: 'Join Me on Gaming Tournament!',
                text: `Join using my referral code: ${code} & get rewards! App: ${window.location.origin}`,
                url: window.location.origin
            }).catch((error) => console.log('Error sharing', error));
        }

        function generateReferralCode(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function getTimeRemaining(startTime) {
            if (!startTime) return 'TBA';
            const now = Date.now();
            const diff = startTime - now;
            if (diff <= 0) return 'Starting Soon';
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            let output = '';
            if (days > 0) output += `${days}d `;
            if (hours > 0 || days > 0) output += `${hours}h `;
            output += `${minutes}m`;
            return output.trim() || 'Now';
        }

        const removePlaceholders = (parentElement) => {
            if (!parentElement) return;
            parentElement.classList.remove('placeholder-glow');
            const placeholders = parentElement.querySelectorAll('.placeholder');
            placeholders.forEach(el => {
                if (el.parentNode) {
                    el.parentNode.removeChild(el);
                }
            });
        };

        // --- UI Functions ---
        function showSection(sectionId) {
            if (!auth || !sectionId || !elements.sections) {
                console.error("Cannot show section", sectionId);
                return;
            }
            
            const targetSection = getElement(sectionId);
            if (!targetSection) {
                console.error(`Section element "${sectionId}" not found.`);
                showSection(currentUser ? 'home-section' : 'login-section');
                return;
            }
            
            const protectedSections = ['home-section', 'wallet-section', 'earnings-section', 'profile-section', 'tournaments-section'];
            const isLoggedIn = !!currentUser;
            
            if (protectedSections.includes(sectionId) && !isLoggedIn) {
                showSection('login-section');
                return;
            }
            
            if (sectionId === 'login-section' && isLoggedIn) {
                showSection('home-section');
                return;
            }
            
            elements.sections.forEach(sec => sec.classList.remove('active'));
            targetSection.classList.add('active');
            currentSectionId = sectionId;
            
            updateHeaderForSection(sectionId);
            
            elements.bottomNavItems.forEach(item => {
                item.classList.toggle('active', item.dataset.section === sectionId);
            });
            
            console.log(`Loading data for section: ${sectionId}`);
            switch (sectionId) {
                case 'home-section': 
                    loadHomePageData(); 
                    break;
                case 'wallet-section': 
                    loadWalletData(); 
                    break;
                case 'profile-section': 
                    loadProfileData(); 
                    break;
                case 'earnings-section': 
                    loadEarningsData(); 
                    break;
                case 'tournaments-section':
                    if (currentTournamentGameId) {
                        const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                        filterTournaments(currentTournamentGameId, activeTab);
                    } else {
                        elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>';
                    }
                    break;
            }
            
            if (sectionId === 'login-section') {
                toggleLoginForm(true);
            }
            
            window.scrollTo(0, 0);
        }

        function updateHeaderForSection(sectionId) {
            const showBackButton = (sectionId === 'tournaments-section');
            const defaultTitleVisible = !showBackButton;
            const gameTitleVisible = showBackButton;
            
            if (elements.headerBackBtn) {
                elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
            }
            
            if (elements.headerTitleContainer) {
                elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
            }
            
            if (elements.headerGameTitle) {
                elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none';
            }
            
            if (gameTitleVisible && currentTournamentGameId && elements.headerGameTitle) {
                const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`;
                elements.headerGameTitle.textContent = gameName;
            } else if (defaultTitleVisible && elements.headerUserGreeting) {
                const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest';
                elements.headerUserGreeting.textContent = nameToShow;
            }
        }

        function updateGlobalUI(isLoggedIn) {
            if (elements.headerWalletChip) {
                elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none';
                if (isLoggedIn) {
                    elements.headerWalletChip.onclick = () => showSection('wallet-section');
                } else {
                    elements.headerWalletChip.onclick = null;
                }
            }
            
            if (!isLoggedIn && elements.headerUserGreeting) {
                elements.headerUserGreeting.textContent = 'Guest';
            }
            
            if (!isLoggedIn && elements.headerChipBalance) {
                elements.headerChipBalance.textContent = '0';
            }
            
            elements.bottomNavItems.forEach(item => {
                const section = item.dataset.section;
                item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none';
            });
            
            // Show refresh button only when logged in
            if (elements.refreshDataBtn) {
                elements.refreshDataBtn.style.display = isLoggedIn ? 'block' : 'none';
            }
        }

        function populateUserInfo(user, profile) {
            if (!user || !profile) return;
            
            const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
            
            // FIXED: Calculate total balance correctly
            const winningCash = parseFloat(profile.winningCash || 0);
            const bonusCash = parseFloat(profile.bonusCash || 0);
            const totalBalance = winningCash + bonusCash;
            
            const totalEarnings = (profile.totalEarnings || 0);
            const referralEarnings = (profile.referralEarnings || 0);
            const totalMatches = profile.totalMatches || 0;
            const wonMatches = profile.wonMatches || 0;
            
            const formatCurrency = (amount) => `â‚¹${amount.toFixed(2)}`;
            
            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];
            if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(totalBalance);
            
            if (elements.walletTotalBalance) {
                elements.walletTotalBalance.textContent = formatCurrency(totalBalance);
                removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow'));
            }
            
            if (elements.walletWinningCash) {
                elements.walletWinningCash.textContent = formatCurrency(winningCash);
                removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow'));
            }
            
            if (elements.walletBonusCash) {
                elements.walletBonusCash.textContent = formatCurrency(bonusCash);
                removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow'));
            }
            
            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash);
            
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            
            if (elements.profileName) {
                elements.profileName.textContent = displayName;
                removePlaceholders(elements.profileName.closest('.placeholder-glow'));
            }
            
            if (elements.profileEmail) {
                elements.profileEmail.textContent = user.email || 'N/A';
                removePlaceholders(elements.profileEmail.closest('.placeholder-glow'));
            }
            
            if (elements.profileTotalMatches) {
                elements.profileTotalMatches.textContent = totalMatches;
                removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow'));
            }
            
            if (elements.profileWonMatches) {
                elements.profileWonMatches.textContent = wonMatches;
                removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow'));
            }
            
            if (elements.profileTotalEarnings) {
                elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings);
                removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow'));
            }
            
            // NEW: Show winning amount in profile
            if (elements.profileWinningAmount) {
                elements.profileWinningAmount.textContent = formatCurrency(winningCash);
                removePlaceholders(elements.profileWinningAmount.closest('.placeholder-glow'));
            }
            
            if (elements.earningsTotal) {
                elements.earningsTotal.textContent = formatCurrency(totalEarnings);
                removePlaceholders(elements.earningsTotal.closest('.placeholder-glow'));
            }
            
            if (elements.earningsReferral) {
                elements.earningsReferral.textContent = formatCurrency(referralEarnings);
                removePlaceholders(elements.earningsReferral.closest('.placeholder-glow'));
            }
            
            if (elements.modalUserEmail) elements.modalUserEmail.textContent = user.email || 'N/A';
        }

        function toggleLoginForm(showLogin) {
            if (!elements.emailLoginForm || !elements.emailSignupForm) return;
            
            clearStatusMessage(elements.loginStatusMessage);
            clearStatusMessage(elements.signupStatusMessage);
            
            elements.emailLoginForm.style.display = showLogin ? 'block' : 'none';
            elements.emailSignupForm.style.display = showLogin ? 'none' : 'block';
            
            elements.emailLoginForm.reset();
            elements.emailSignupForm.reset();
        }

        // --- Firebase Auth Functions ---
        async function signUpWithEmail() {
            if (!auth) return;
            
            const name = elements.signupNameInput.value.trim();
            const email = elements.signupEmailInput.value.trim();
            const password = elements.signupPasswordInput.value;
            const confirmPassword = elements.signupConfirmPasswordInput.value;
            const referralCode = elements.signupReferralCodeInput.value.trim();

            if (!name || !email || !password || !confirmPassword) {
                showStatusMessage(elements.signupStatusMessage, 'Fill all required fields.', 'warning');
                return;
            }
            
            if (password !== confirmPassword) {
                showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning');
                return;
            }
            
            if (password.length < 6) {
                showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning');
                return;
            }

            showLoader(true);
            clearStatusMessage(elements.signupStatusMessage);
            validReferrerUid = null;

            try {
                // Validate referral code if provided
                if (referralCode) {
                    console.log("Validating referral code:", referralCode);
                    const usersRef = ref(db, 'users');
                    const q = query(usersRef, orderByChild('referralCode'), equalTo(referralCode));
                    const snapshot = await get(q);
                    
                    if (snapshot.exists()) {
                        const referrerData = snapshot.val();
                        const referrerId = Object.keys(referrerData)[0];
                        const referrerProfile = referrerData[referrerId];
                        
                        if (referrerId && referrerProfile.email) {
                            validReferrerUid = referrerId;
                            console.log("Valid referrer found:", validReferrerUid);
                        } else {
                            console.warn("Referral code found, but referrer data invalid");
                        }
                    } else {
                        console.log("Referral code not found:", referralCode);
                    }
                }

                // Create the user
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Update profile with name
                await updateProfile(userCredential.user, {
                    displayName: name
                });
                
            } catch (error) {
                console.error("Signup Error:", error);
                let message = `Signup failed.`;
                
                switch (error.code) {
                    case 'auth/email-already-in-use': 
                        message = 'Email already registered.';
                        break;
                    case 'auth/weak-password': 
                        message = 'Password too weak.';
                        break;
                    case 'auth/invalid-email': 
                        message = 'Invalid email.';
                        break;
                    case 'auth/network-request-failed': 
                        message = 'Network error.';
                        break;
                    default: 
                        message = `Error: ${error.message}`;
                }
                
                showStatusMessage(elements.signupStatusMessage, message, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function loginWithEmail() {
            if (!auth) return;
            
            const email = elements.loginEmailInput.value.trim();
            const password = elements.loginPasswordInput.value;
            
            if (!email || !password) {
                showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning');
                return;
            }
            
            showLoader(true);
            clearStatusMessage(elements.loginStatusMessage);
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login Error:", error);
                let message = `Login failed.`;
                
                switch (error.code) {
                    case 'auth/user-not-found': 
                    case 'auth/wrong-password': 
                    case 'auth/invalid-credential': 
                        message = 'Invalid email or password.';
                        break;
                    case 'auth/invalid-email': 
                        message = 'Invalid email format.';
                        break;
                    case 'auth/too-many-requests': 
                        message = 'Too many attempts. Reset pass or wait.';
                        break;
                    case 'auth/network-request-failed': 
                        message = 'Network error.';
                        break;
                    case 'auth/user-disabled': 
                        message = 'Account disabled.';
                        break;
                    default: 
                        message = `Error: ${error.message}`;
                }
                
                showStatusMessage(elements.loginStatusMessage, message, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function resetPassword() {
            if (!auth) return;
            
            const email = elements.loginEmailInput.value.trim();
            
            if (!email) {
                showStatusMessage(elements.loginStatusMessage, 'Enter email for password reset.', 'warning');
                return;
            }
            
            showLoader(true);
            clearStatusMessage(elements.loginStatusMessage);
            
            try {
                await sendPasswordResetEmail(auth, email);
                showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check inbox/spam.', 'success', false);
            } catch (error) {
                console.error("Reset Pass Error:", error);
                let message = `Failed to send email.`;
                
                switch (error.code) {
                    case 'auth/user-not-found': 
                    case 'auth/invalid-email': 
                        message = 'Email not found.';
                        break;
                    case 'auth/network-request-failed': 
                        message = 'Network error.';
                        break;
                    default: 
                        message = `Error: ${error.message}`;
                }
                
                showStatusMessage(elements.loginStatusMessage, message, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function logoutUser() {
            if (!auth) return;
            
            try {
                showLoader(true);
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Error:", error);
                alert(`Logout failed: ${error.message}`);
                showLoader(false);
            }
        }

        // --- Auth State Change Handler ---
        async function handleAuthStateChange(user) {
            if (!auth || !db) {
                console.error("Firebase not ready in auth change");
                showLoader(false);
                return;
            }
            
            showLoader(true);
            detachAllDbListeners();
            currentUser = user;
            
            const localReferrerUid = validReferrerUid;
            validReferrerUid = null;

            if (user) {
                console.log("Auth State: Logged In", user.uid);
                const userRef = ref(db, 'users/' + user.uid);
                
                try {
                    const snapshot = await get(userRef);
                    
                    if (snapshot.exists()) {
                        // Existing user
                        userProfile = snapshot.val();
                        const updates = {};
                        
                        if (user.displayName && (!userProfile.displayName || userProfile.displayName !== user.displayName)) {
                            updates.displayName = user.displayName;
                        }
                        
                        if (user.email && !userProfile.email) {
                            updates.email = user.email;
                        }
                        
                        if (Object.keys(updates).length > 0) {
                            await update(userRef, updates);
                            userProfile = { ...userProfile, ...updates };
                        }
                    } else {
                        // New user
                        console.log("New user, creating profile...");
                        const newUserProfile = {
                            uid: user.uid,
                            displayName: user.displayName || user.email?.split('@')[0] || 'User',
                            email: user.email || null,
                            photoURL: user.photoURL || null,
                            balance: appSettings.newUserBalance || 0,
                            winningCash: 0,
                            bonusCash: appSettings.newUserBonus || 0, // FIXED: Set default bonus cash to 50
                            totalMatches: 0,
                            wonMatches: 0,
                            totalEarnings: 0,
                            referralEarnings: 0,
                            createdAt: Date.now(),
                            referralCode: generateReferralCode(),
                            joinedTournaments: {},
                            isAdmin: false,
                            ...(localReferrerUid && { referredBy: localReferrerUid })
                        };
                        
                        await set(userRef, newUserProfile);
                        userProfile = newUserProfile;

                        // Award signup bonus
                        if (newUserProfile.bonusCash > 0) {
                            await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`);
                        }

                        // Award referral bonus to referrer
                        if (localReferrerUid && appSettings.referralBonus > 0) {
                            console.log(`Awarding referral bonus of ${appSettings.referralBonus} to referrer: ${localReferrerUid}`);
                            const referrerRef = ref(db, `users/${localReferrerUid}`);
                            
                            try {
                                const referrerUpdateResult = await runTransaction(referrerRef, (referrerData) => {
                                    if (referrerData) {
                                        referrerData.bonusCash = (referrerData.bonusCash || 0) + appSettings.referralBonus;
                                        referrerData.referralEarnings = (referrerData.referralEarnings || 0) + appSettings.referralBonus;
                                    }
                                    return referrerData;
                                });

                                if (referrerUpdateResult.committed) {
                                    await recordTransaction(
                                        localReferrerUid, 
                                        'referral_bonus', 
                                        appSettings.referralBonus, 
                                        `Referral Bonus from ${newUserProfile.displayName || newUserProfile.email}`
                                    );
                                    console.log("Referrer bonus awarded successfully.");
                                } else {
                                    console.error("Referrer bonus transaction aborted.");
                                }
                            } catch (referrerError) {
                                console.error("Error awarding referrer bonus:", referrerError);
                            }
                        }
                    }
                    
                    populateUserInfo(user, userProfile);
                    setupRealtimeListeners(user.uid);
                    updateGlobalUI(true);
                    
                    const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                    showSection(targetSection);
                    
                } catch (error) {
                    console.error("Profile handling error:", error);
                    alert("Error loading profile. Logging out. " + error.message);
                    try {
                        await logoutUser();
                    } catch (logoutErr) {
                        console.error("Logout error:", logoutErr);
                    }
                }
            } else {
                // Logged Out
                console.log("Auth State: Logged Out");
                currentUser = null;
                userProfile = {};
                updateGlobalUI(false);
                showSection('login-section');
            }
            
            showLoader(false);
        }

        // --- Database Interaction Functions ---
        async function loadAppSettings() {
            console.log("Loading App Settings...");
            
            try {
                const settingsRef = ref(db, 'settings');
                const snapshot = await get(settingsRef);
                
                if (snapshot.exists()) {
                    appSettings = snapshot.val() || {};
                    console.log("App Settings Loaded:", appSettings);

                    if (appSettings.logoUrl && elements.appLogo) {
                        elements.appLogo.src = appSettings.logoUrl;
                    }
                    
                    if (appSettings.minWithdraw && elements.minWithdrawAmount) {
                        elements.minWithdrawAmount.textContent = appSettings.minWithdraw;
                    }

                    // Update UPI details in the add amount modal
                    if (appSettings.upiDetails && elements.upiIdDisplay) {
                        elements.upiIdDisplay.textContent = appSettings.upiDetails;
                        
                        // Update QR code with the actual UPI ID
                        if (elements.qrCodeImage) {
                            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=${encodeURIComponent(appSettings.upiDetails)}&pn=Gaming%20Tournament&am=&cu=INR`;
                            elements.qrCodeImage.src = qrCodeUrl;
                        }
                    }
                    
                    // Update admin contact info
                    if (appSettings.supportContact && elements.adminContactDisplay) {
                        elements.adminContactDisplay.textContent = appSettings.supportContact;
                    }
                    
                    // Check for custom QR code URL
                    if (appSettings.qrCodeUrl && elements.qrCodeImage) {
                        elements.qrCodeImage.src = appSettings.qrCodeUrl;
                    }
                    
                } else {
                    console.warn("App Settings not found in database!");
                    appSettings = {};
                }
            } catch (error) {
                console.error("Settings load failed", error);
                appSettings = {};
            }
        }

        function loadHomePageData() {
            console.log("Loading Home Page Data...");
            
            if (!currentUser) {
                console.log("User not logged in, skipping home data load.");
                if (elements.promotionSlider?.querySelector('.swiper-wrapper')) {
                    elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = '';
                }
                if (elements.gamesList) elements.gamesList.innerHTML = '';
                if (elements.myContestsList) {
                    elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view contests.</p>';
                }
                return;
            }
            
            loadPromotions();
            loadGames();
            loadMyContests();
        }

        async function loadPromotions() {
            console.log("Loading Promotions...");
            
            if (!elements.promotionSlider) return;
            
            const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
            if (!sliderWrapper) return;
            
            sliderWrapper.classList.add('placeholder-glow');
            sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>`;

            try {
                const promoRef = ref(db, 'promotions');
                const snapshot = await get(promoRef);
                const promotions = snapshot.val() || {};
                const activePromotions = Object.values(promotions).filter(p => p.imageUrl);
                console.log(`Found ${activePromotions.length} active promotions.`);

                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '';

                if (activePromotions.length > 0) {
                    elements.promotionSlider.style.display = 'block';
                    
                    activePromotions.forEach(promo => {
                        const slide = document.createElement('div');
                        slide.className = 'swiper-slide';
                        
                        if (promo.link) {
                            slide.innerHTML = `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>`;
                        } else {
                            slide.innerHTML = `<img src="${promo.imageUrl}" alt="Promo">`;
                        }
                        
                        sliderWrapper.appendChild(slide);
                    });

                    if (swiperInstance) {
                        swiperInstance.destroy(true, true);
                    }
                    
                    swiperInstance = new Swiper(elements.promotionSlider, {
                        loop: activePromotions.length > 1,
                        autoplay: { delay: 3500, disableOnInteraction: false },
                        pagination: { el: '.swiper-pagination', clickable: true },
                        slidesPerView: 1
                    });
                } else {
                    elements.promotionSlider.style.display = 'none';
                }
            } catch (error) {
                console.error("Promo load failed:", error);
                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>';
                elements.promotionSlider.style.display = 'block';
            }
        }

        async function loadGames() {
            console.log("Loading Games...");
            
            if (!elements.gamesList) return;
            
            elements.gamesList.classList.add('placeholder-glow');
            elements.gamesList.innerHTML = `
                <div class="col-6">
                    <div class="game-card custom-card">
                        <span class="placeholder d-block" style="height: 130px;"></span>
                        <span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="game-card custom-card">
                        <span class="placeholder d-block" style="height: 130px;"></span>
                        <span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span>
                    </div>
                </div>
            `;

            try {
                const gamesRef = ref(db, 'games');
                const snapshot = await get(gamesRef);
                const games = snapshot.val() || {};
                
                const activeGames = Object.entries(games)
                    .filter(([, game]) => game.imageUrl && game.name)
                    .sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0));
                
                console.log(`Found ${activeGames.length} active games.`);

                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = '';

                if (activeGames.length > 0) {
                    if (!appSettings.games) appSettings.games = {};
                    
                    activeGames.forEach(([gameId, game]) => {
                        appSettings.games[gameId] = { name: game.name };
                        
                        const col = document.createElement('div');
                        col.className = 'col-6';
                        col.innerHTML = `
                            <div class="game-card custom-card" data-game-id="${gameId}" data-game-name="${game.name}">
                                <img src="${game.imageUrl}" alt="${game.name}" class="lazy-load" onload="this.classList.add('lazy-loaded')">
                                <span>${game.name}</span>
                            </div>
                        `;
                        
                        col.querySelector('.game-card').addEventListener('click', () => {
                            currentTournamentGameId = gameId;
                            loadTournamentsForGame(gameId, game.name);
                        });
                        
                        elements.gamesList.appendChild(col);
                    });
                } else {
                    elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>';
                }
            } catch (error) {
                console.error("Games load failed:", error);
                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>';
            }
        }

        function loadTournamentsForGame(gameId, gameName) {
            console.log(`Loading tournaments for game: ${gameName} (ID: ${gameId})`);
            
            if (!elements.tournamentsSection) return;
            
            currentTournamentGameId = gameId;
            elements.tournamentTabs.forEach(t => t.classList.remove('active'));
            querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active');
            
            showSection('tournaments-section');
            filterTournaments(gameId, 'upcoming');
        }

        async function filterTournaments(gameId, status) {
            console.log(`Filtering tournaments for game ${gameId} with status ${status}`);
            
            if (!elements.tournamentsListContainer) return;
            
            elements.tournamentsListContainer.innerHTML = '';
            elements.tournamentsListContainer.classList.add('placeholder-glow');
            elements.tournamentsListContainer.innerHTML = `
                <div class="tournament-card placeholder-glow mb-3">
                    <span class="placeholder col-6"></span>
                    <span class="placeholder col-12 mt-2"></span>
                    <span class="placeholder col-10 mt-2"></span>
                    <div class="d-flex justify-content-between mt-3">
                        <span class="placeholder col-4 h-30"></span>
                        <span class="placeholder col-4 h-30"></span>
                    </div>
                </div>
            `;
            
            elements.noTournamentsMessage.style.display = 'none';

            try {
                const tournamentsQuery = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId));
                const snapshot = await get(tournamentsQuery);
                const allTournaments = snapshot.val() || {};
                
                const filteredTournaments = Object.entries(allTournaments)
                    .filter(([, tournament]) => tournament.status === status)
                    .sort(([, tournamentA], [, tournamentB]) => (tournamentA.startTime || 0) - (tournamentB.startTime || 0));
                
                console.log(`Found ${filteredTournaments.length} tournaments matching criteria.`);

                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '';

                if (filteredTournaments.length > 0) {
                    filteredTournaments.forEach(([tournamentId, tournament]) => {
                        const card = createTournamentCardElement(tournamentId, tournament);
                        elements.tournamentsListContainer.appendChild(card);
                    });
                } else {
                    elements.noTournamentsMessage.style.display = 'block';
                    elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`;
                }
            } catch (error) {
                console.error(`Tournaments filter failed (${status}):`, error);
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '<p class="text-danger tc mt-4">Could not load tournaments.</p>';
                elements.noTournamentsMessage.style.display = 'none';
            }
        }

        function createTournamentCardElement(tournamentId, tournament) {
            const card = document.createElement('div');
            card.className = 'tournament-card';
            card.dataset.tournamentId = tournamentId;
            
            const entryFee = tournament.entryFee || 0;
            const perKillPrize = tournament.perKillPrize || 0;
            const prizePool = tournament.prizePool || 0;
            const startTime = tournament.startTime ? new Date(tournament.startTime) : null;
            const startTimeLocal = startTime ? startTime.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA';
            const registeredPlayers = tournament.registeredPlayers || {};
            const registeredCount = Object.keys(registeredPlayers).length;
            const maxPlayers = tournament.maxPlayers || 0;
            const spotsLeft = maxPlayers > 0 ? Math.max(0, maxPlayers - registeredCount) : Infinity;
            const isFull = maxPlayers > 0 && spotsLeft <= 0;
            const isJoined = currentUser && userProfile?.joinedTournaments?.[tournamentId];
            const canJoin = !isJoined && !isFull && tournament.status === 'upcoming';
            
            let timerText = tournament.status?.toUpperCase() || 'N/A';
            if (tournament.status === 'upcoming' && startTime) {
                timerText = getTimeRemaining(tournament.startTime);
            } else if (tournament.status === 'ongoing') {
                timerText = 'LIVE';
            } else if (tournament.status === 'completed' || tournament.status === 'result') {
                timerText = 'ENDED';
            }
            
            let spotsText = 'Unlimited Spots';
            let progressPercent = 0;
            
            if (maxPlayers > 0) {
                spotsText = `<span class="${spotsLeft <= 5 ? 'text-danger' : 'text-accent'}">${spotsLeft}</span> Spots Left (${registeredCount}/${maxPlayers})`;
                progressPercent = Math.min(100, (registeredCount / maxPlayers) * 100);
            }
            
            let actionButton = '';
            let idPassButton = '';
            let winnerSection = '';
            
            // Add winner section for completed tournaments
            if (tournament.status === 'completed' && tournament.winner) {
                const winner = tournament.winner;
                winnerSection = `
                    <div class="tournament-winner">
                        <i class="bi bi-trophy-fill tournament-winner-icon"></i>
                        <div class="tournament-winner-details">
                            <div class="tournament-winner-name">Winner: ${winner.name || 'Unknown'}</div>
                            <div class="tournament-winner-prize">Prize: â‚¹${winner.prize || prizePool}</div>
                        </div>
                    </div>
                `;
            }
            
            if (isJoined) {
                actionButton = `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`;
                
                if (tournament.status === 'ongoing' || (tournament.status === 'upcoming' && tournament.showIdPass && startTime && Date.now() > startTime.getTime() - 900000)) {
                    idPassButton = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tournamentId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
                }
            } else if (canJoin) {
                actionButton = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tournamentId}" data-fee="${entryFee}">â‚¹${entryFee} Join <i class="bi bi-arrow-right-short"></i></button>`;
            } else {
                let disabledReason = tournament.status !== 'upcoming' ? tournament.status?.toUpperCase() : (isFull ? 'Full' : 'Closed');
                actionButton = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disabledReason || 'N/A'}</button>`;
            }
            
            card.innerHTML = `
                <div class="tournament-card-header">
                    <div class="tournament-card-tags">
                        ${tournament.mode ? `<span>${tournament.mode}</span>` : ''}
                        ${tournament.map ? `<span>${tournament.map}</span>` : ''}
                        ${tournament.tags ? (Array.isArray(tournament.tags) ? 
                            tournament.tags.map(tag => `<span>${tag}</span>`).join('') : 
                            Object.values(tournament.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}
                    </div>
                    <div class="tournament-card-timer">${timerText}</div>
                </div>
                <h3 class="tournament-card-title">
                    ${tournament.icon ? `<i class="${tournament.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'} 
                    ${tournament.name || 'Tournament'}
                </h3>
                <p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${startTimeLocal}</p>
                <div class="tournament-card-info">
                    <div class="info-item">
                        <span>Prize Pool</span>
                        <strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> â‚¹${prizePool}</strong>
                    </div>
                    <div class="info-item">
                        <span>Per Kill</span>
                        <strong>â‚¹${perKillPrize}</strong>
                    </div>
                    <div class="info-item">
                        <span>Entry Fee</span>
                        <strong class="${entryFee > 0 ? 'text-info' : ''}">${entryFee > 0 ? `â‚¹${entryFee}` : 'Free'}</strong>
                    </div>
                </div>
                <div class="tournament-card-spots">
                    ${spotsText}
                    ${maxPlayers > 0 ? `<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progressPercent}%"></div></div>` : ''}
                </div>
                <div class="tournament-card-actions">
                    <button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tournamentId}">Details</button>
                    ${actionButton}
                </div>
                ${idPassButton}
                ${winnerSection}
            `;
            
            const joinBtn = card.querySelector('.btn-join');
            if (joinBtn) {
                joinBtn.addEventListener('click', handleJoinTournamentClick);
            }
            
            const detailsBtn = card.querySelector('.btn-details');
            if (detailsBtn) {
                detailsBtn.addEventListener('click', handleMatchDetailsClick);
            }
            
            const idPassBtn = card.querySelector('.btn-idpass');
            if (idPassBtn) {
                idPassBtn.addEventListener('click', handleIdPasswordClick);
            }
            
            return card;
        }

        async function loadMyContests() {
            console.log("Loading My Contests...");
            
            if (!currentUser || !elements.myContestsList) {
                if (elements.myContestsList) {
                    removePlaceholders(elements.myContestsList);
                    elements.myContestsList.innerHTML = '';
                }
                if (elements.noContestsMessage) {
                    elements.noContestsMessage.style.display = 'block';
                }
                return;
            }
            
            const joinedIds = Object.keys(userProfile.joinedTournaments || {});
            elements.myContestsList.classList.add('placeholder-glow');
            elements.myContestsList.innerHTML = `
                <div class="tournament-card placeholder-glow mb-3">
                    <span class="placeholder col-6"></span>
                    <span class="placeholder col-12 mt-2"></span>
                    <span class="placeholder col-10 mt-2"></span>
                    <div class="d-flex justify-content-between mt-3">
                        <span class="placeholder col-4 h-30"></span>
                        <span class="placeholder col-4 h-30"></span>
                    </div>
                </div>
            `;
            
            if (elements.noContestsMessage) {
                elements.noContestsMessage.style.display = 'none';
            }
            
            if (joinedIds.length === 0) {
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '';
                if (elements.noContestsMessage) {
                    elements.noContestsMessage.style.display = 'block';
                }
                console.log("No joined contests found for user.");
                return;
            }
            
            console.log(`Found ${joinedIds.length} joined contest IDs.`);
            
            try {
                const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
                const snapshots = await Promise.all(contestPromises);
                
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '';
                
                const contestCards = [];
                
                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists()) {
                        const tournament = snapshot.val();
                        const tournamentId = joinedIds[index];
                        
                        // Only show upcoming or ongoing tournaments in "My Contests"
                        if (tournament.status === 'upcoming' || tournament.status === 'ongoing') {
                            contestCards.push({
                                startTime: tournament.startTime || 0,
                                card: createTournamentCardElement(tournamentId, tournament)
                            });
                        }
                    } else {
                        console.warn(`Joined tournament ${joinedIds[index]} not found in tournaments node.`);
                    }
                });
                
                contestCards.sort((a, b) => a.startTime - b.startTime);
                
                if (contestCards.length > 0) {
                    contestCards.forEach(item => {
                        elements.myContestsList.appendChild(item.card);
                    });
                } else if (elements.noContestsMessage) {
                    elements.noContestsMessage.style.display = 'block';
                    elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests.";
                }
            } catch (error) {
                console.error("My contests load failed:", error);
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>';
            }
        }

        function loadWalletData() {
            console.log("Loading Wallet Data...");
            if (!currentUser) return;
            loadRecentTransactions();
        }

        function loadProfileData() {
            console.log("Loading Profile Data...");
            if (!currentUser) return;
            
            if (userProfile?.displayName) {
                removePlaceholders(elements.profileName?.closest('.placeholder-glow'));
                removePlaceholders(elements.profileEmail?.closest('.placeholder-glow'));
                removePlaceholders(elements.profileTotalMatches?.closest('.placeholder-glow'));
                removePlaceholders(elements.profileWonMatches?.closest('.placeholder-glow'));
                removePlaceholders(elements.profileTotalEarnings?.closest('.placeholder-glow'));
                removePlaceholders(elements.profileWinningAmount?.closest('.placeholder-glow'));
            }
        }

        function loadEarningsData() {
            console.log("Loading Earnings Data...");
            if (!currentUser) return;
            
            if (typeof userProfile?.totalEarnings !== 'undefined') {
                removePlaceholders(elements.earningsTotal?.closest('.placeholder-glow'));
            }
            if (typeof userProfile?.referralEarnings !== 'undefined') {
                removePlaceholders(elements.earningsReferral?.closest('.placeholder-glow'));
            }
        }

        async function recordTransaction(userId, type, amount, description, details = {}) {
            if (!userId) return;
            
            const transactionRef = ref(db, `transactions/${userId}`);
            const newTransaction = {
                type,
                amount,
                description,
                timestamp: Date.now(),
                ...details
            };
            
            try {
                await push(transactionRef, newTransaction);
                console.log(`Transaction recorded: ${type}, Amount: ${amount}`);
            } catch (error) {
                console.error("Transaction record failed:", error);
            }
        }

        async function loadRecentTransactions() {
            console.log("Loading Recent Transactions...");
            
            if (!currentUser || !elements.recentTransactionsList) return;
            
            const limit = 5;
            elements.recentTransactionsList.innerHTML = '';
            elements.recentTransactionsList.classList.add('placeholder-glow');
            
            for (let i = 0; i < 3; i++) {
                elements.recentTransactionsList.innerHTML += `
                    <div class="custom-card p-2 mb-2 placeholder-glow">
                        <div class="d-flex justify-content-between">
                            <span class="placeholder col-5 h-16"></span>
                            <span class="placeholder col-3 h-16"></span>
                        </div>
                        <div class="small text-secondary mt-1">
                            <span class="placeholder col-6 h-14"></span>
                        </div>
                    </div>
                `;
            }
            
            if (elements.noTransactionsMessage) {
                elements.noTransactionsMessage.style.display = 'block';
                elements.noTransactionsMessage.textContent = 'Loading transactions...';
            }

            try {
                const transactionsRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit));
                const snapshot = await get(transactionsRef);
                const transactions = snapshot.val() || {};
                const sortedTransactions = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                console.log(`Found ${sortedTransactions.length} recent transactions.`);

                removePlaceholders(elements.recentTransactionsList);
                elements.recentTransactionsList.innerHTML = '';

                if (sortedTransactions.length > 0) {
                    if (elements.noTransactionsMessage) {
                        elements.noTransactionsMessage.style.display = 'none';
                    }
                    
                    sortedTransactions.forEach(transaction => {
                        const item = document.createElement('div');
                        item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center';
                        
                        const isCredit = transaction.amount > 0;
                        const amount = `${isCredit ? '+' : ''}â‚¹${Math.abs(transaction.amount || 0).toFixed(2)}`;
                        const time = transaction.timestamp ? 
                            new Date(transaction.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 
                            'N/A';
                        
                        item.innerHTML = `
                            <div>
                                <div class="small fw-bold">${transaction.description || transaction.type || 'Txn'}</div>
                                <div class="small text-secondary">${time}</div>
                            </div>
                            <div class="fw-bold ${isCredit ? 'text-success' : 'text-danger'}">${amount}</div>
                        `;
                        
                        elements.recentTransactionsList.appendChild(item);
                    });
                } else if (elements.noTransactionsMessage) {
                    elements.noTransactionsMessage.style.display = 'block';
                    elements.noTransactionsMessage.textContent = 'No recent transactions.';
                }
            } catch (error) {
                console.error("Transactions load failed:", error);
                removePlaceholders(elements.recentTransactionsList);
                elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>';
                if (elements.noTransactionsMessage) {
                    elements.noTransactionsMessage.style.display = 'none';
                }
            }
        }

        async function handleJoinTournamentClick(event) {
            if (!currentUser) {
                alert("Login to join.");
                showSection('login-section');
                return;
            }
            
            const button = event.currentTarget;
            const tournamentId = button.dataset.tournamentId;
            const fee = parseFloat(button.dataset.fee || 0);
            
            if (!tournamentId) return;
            
            if (!confirm(`Join for â‚¹${fee.toFixed(2)}?`)) return;
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            const userRef = ref(db, `users/${currentUser.uid}`);
            const tournamentRef = ref(db, `tournaments/${tournamentId}`);
            
            let tournamentData = null;
            let transactionResult = null;

            try {
                // Step 1: Check balance and mark as joined in transaction
                transactionResult = await runTransaction(userRef, (profileData) => {
                    if (!profileData) {
                        throw new Error("User profile missing.");
                    }
                    
                    // FIXED: Calculate total balance correctly
                    const winningCash = parseFloat(profileData.winningCash || 0);
                    const bonusCash = parseFloat(profileData.bonusCash || 0);
                    const totalBalance = winningCash + bonusCash;
                    
                    if (totalBalance < fee) {
                        throw new Error("Insufficient balance.");
                    }
                    
                    if (profileData.joinedTournaments?.[tournamentId]) {
                        console.warn("Already joined (Tx check).");
                        return; // Abort transaction
                    }
                    
                    // FIXED: Deduct from bonus cash first, then winning cash
                    let remainingFee = fee;
                    
                    // First use bonus cash
                    if (bonusCash > 0) {
                        const bonusDeduction = Math.min(remainingFee, bonusCash);
                        profileData.bonusCash = bonusCash - bonusDeduction;
                        remainingFee -= bonusDeduction;
                    }
                    
                    // Then use winning cash if needed
                    if (remainingFee > 0) {
                        profileData.winningCash = winningCash - remainingFee;
                    }
                    
                    // Mark as joined
                    if (!profileData.joinedTournaments) {
                        profileData.joinedTournaments = {};
                    }
                    profileData.joinedTournaments[tournamentId] = true;
                    
                    return profileData;
                });

                if (!transactionResult.committed && userProfile?.joinedTournaments?.[tournamentId]) {
                    console.log("Join aborted because user already joined.");
                    throw new Error("Already joined this tournament.");
                } else if (!transactionResult.committed) {
                    throw new Error("Join transaction failed.");
                }

                console.log("Balance transaction successful.");

                // Step 2: Update tournament registered players
                const snapshot = await get(tournamentRef);
                if (!snapshot.exists()) {
                    throw new Error("Tournament not found after transaction.");
                }
                
                tournamentData = snapshot.val();
                
                if (tournamentData.status !== 'upcoming') {
                    throw new Error("Tournament closed after balance check.");
                }
                
                const registeredCount = tournamentData.registeredPlayers ? Object.keys(tournamentData.registeredPlayers).length : 0;
                if (tournamentData.maxPlayers > 0 && registeredCount >= tournamentData.maxPlayers) {
                    throw new Error("Tournament full after balance check.");
                }

                const updates = {};
                updates[`tournaments/${tournamentId}/registeredPlayers/${currentUser.uid}`] = { 
                    joinedAt: serverTimestamp() 
                };

                console.log("Attempting to update registered players:", updates);
                await update(ref(db), updates);
                console.log("Successfully updated tournament registered players.");

                // Step 3: Record transaction
                await recordTransaction(
                    currentUser.uid, 
                    'tournament_join', 
                    -fee, 
                    `Joined: ${tournamentData.name || 'Tournament'}`,
                    { tournamentId: tournamentId }
                );
                
                alert(`Joined! â‚¹${fee.toFixed(2)} deducted.`);

                // Step 4: Update UI
                const finalSnapshot = await get(tournamentRef);
                if (finalSnapshot.exists()) {
                    const finalTournamentData = finalSnapshot.val();
                    const cardElement = button.closest('.tournament-card');
                    
                    if (cardElement) {
                        cardElement.parentNode.replaceChild(
                            createTournamentCardElement(tournamentId, finalTournamentData), 
                            cardElement
                        );
                    } else {
                        if (currentSectionId === 'tournaments-section' && currentTournamentGameId) {
                            filterTournaments(currentTournamentGameId, 'upcoming');
                        }
                    }
                    
                    if (currentSectionId === 'home-section') {
                        loadMyContests();
                    }
                } else {
                    console.warn("Tournament data missing after successful join update?");
                    if (currentSectionId === 'tournaments-section' && currentTournamentGameId) {
                        filterTournaments(currentTournamentGameId, 'upcoming');
                    }
                    if (currentSectionId === 'home-section') {
                        loadMyContests();
                    }
                }
                
                if (currentSectionId === 'wallet-section') {
                    loadRecentTransactions();
                }

            } catch (error) {
                console.error("Join failed:", error);
                alert(`Failed: ${error.message}`);
                
                const currentButton = event.currentTarget;
                if (currentButton && error.message !== "Already joined this tournament.") {
                    currentButton.disabled = false;
                    currentButton.innerHTML = `â‚¹${fee.toFixed(2)} Join <i class="bi bi-arrow-right-short"></i>`;
                }
                
                // Attempt refund if balance was deducted but registration failed
                if (error.message !== "Insufficient balance." && 
                    error.message !== "User profile missing." && 
                    error.message !== "Already joined this tournament." && 
                    transactionResult?.committed) {
                    
                    console.error("CRITICAL: Balance deducted but failed to update tournament registration! Attempting refund.");
                    
                    try {
                        const refundTransaction = await runTransaction(userRef, (profileData) => {
                            if (profileData) {
                                // FIXED: Refund to the correct wallet (bonus cash first, then winning cash)
                                let remainingRefund = fee;
                                
                                // First refund to winning cash if it was used
                                const winningCashUsed = Math.min(fee, (parseFloat(profileData.winningCash || 0) < (userProfile.winningCash || 0) ? 
                                    (userProfile.winningCash || 0) - (profileData.winningCash || 0) : 0));
                                
                                if (winningCashUsed > 0) {
                                    profileData.winningCash = (profileData.winningCash || 0) + winningCashUsed;
                                    remainingRefund -= winningCashUsed;
                                }
                                
                                // Then refund to bonus cash
                                if (remainingRefund > 0) {
                                    profileData.bonusCash = (profileData.bonusCash || 0) + remainingRefund;
                                }
                                
                                if (profileData.joinedTournaments?.[tournamentId]) {
                                    delete profileData.joinedTournaments[tournamentId];
                                    if (Object.keys(profileData.joinedTournaments).length === 0) {
                                        delete profileData.joinedTournaments;
                                    }
                                }
                            }
                            return profileData;
                        });
                        
                        if (refundTransaction.committed) {
                            await recordTransaction(
                                currentUser.uid, 
                                'join_failed_refund', 
                                fee, 
                                `Refund Failed Join: ${tournamentData?.name || 'Tournament'}`
                            );
                            alert("Join failed, but your balance was refunded.");
                        } else {
                            throw new Error("Refund transaction failed.");
                        }
                    } catch (refundError) {
                        console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError);
                        alert(`Join failed. CRITICAL: Failed to refund balance (â‚¹${fee.toFixed(2)})! Contact support immediately.`);
                    }
                }
            }
        }

        // --- Modal Handlers ---
        function handleWithdrawClick() {
            if (!currentUser || !elements.withdrawModalInstance) return;
            
            const winningCash = userProfile.winningCash || 0;
            const minWithdraw = appSettings?.minWithdraw || 50;
            
            elements.minWithdrawAmount.textContent = minWithdraw;
            elements.withdrawModalBalance.textContent = `â‚¹${winningCash.toFixed(2)}`;
            elements.withdrawAmountInput.value = '';
            elements.withdrawAmountInput.min = minWithdraw;
            elements.withdrawMethodInput.value = userProfile.upiId || '';
            
            clearStatusMessage(elements.withdrawStatusMessage);
            elements.withdrawModalInstance.show();
        }

        async function submitWithdrawRequestHandler() {
            if (!currentUser || !elements.withdrawModalInstance) return;
            
            const amount = parseFloat(elements.withdrawAmountInput.value);
            const method = elements.withdrawMethodInput.value.trim();
            const winningCash = userProfile.winningCash || 0;
            const minWithdraw = appSettings?.minWithdraw || 50;
            
            clearStatusMessage(elements.withdrawStatusMessage);
            
            if (isNaN(amount) || amount <= 0) {
                showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount.', 'warning');
                return;
            }
            
            if (amount < minWithdraw) {
                showStatusMessage(elements.withdrawStatusMessage, `Min withdraw â‚¹${minWithdraw}.`, 'warning');
                return;
            }
            
            if (amount > winningCash) {
                showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance.', 'warning');
                return;
            }
            
            if (!method) {
                showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning');
                return;
            }
            
            elements.submitWithdrawRequestBtn.disabled = true;
            elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
            
            let transactionCommitted = false;

            try {
                const userRef = ref(db, `users/${currentUser.uid}`);
                
                // Step 1: Deduct winning cash
                const transactionResult = await runTransaction(userRef, (profile) => {
                    if (profile) {
                        if ((profile.winningCash || 0) >= amount) {
                            profile.winningCash = (profile.winningCash || 0) - amount;
                            return profile;
                        } else {
                            throw new Error("Insufficient winning balance (Tx).");
                        }
                    } else {
                        throw new Error("Profile missing (Tx).");
                    }
                });

                if (!transactionResult.committed) {
                    throw new Error("Failed to update balance. Please try again.");
                }
                
                transactionCommitted = true;
                console.log("Winning cash deducted successfully.");

                // Step 2: Create withdrawal request
                const withdrawalsRef = ref(db, 'withdrawals');
                const newRequest = {
                    userId: currentUser.uid,
                    userName: userProfile.displayName || currentUser.email,
                    amount: amount,
                    methodDetails: {
                        methodName: method.includes('@') ? 'UPI' : 'Bank/Other',
                        accountInfo: method
                    },
                    status: 'pending',
                    requestTimestamp: serverTimestamp(),
                    userEmail: currentUser.email || 'N/A'
                };
                
                const newWithdrawalRef = await push(withdrawalsRef, newRequest);
                console.log("Withdrawal request created:", newWithdrawalRef.key);

                // Step 3: Record transaction
                await recordTransaction(
                    currentUser.uid, 
                    'withdraw_request', 
                    -amount, 
                    `Withdrawal Request to ${method}`,
                    { withdrawalId: newWithdrawalRef.key }
                );

                showStatusMessage(elements.withdrawStatusMessage, 'Request submitted successfully!', 'success', false);
                
                setTimeout(() => {
                    if (elements.withdrawModalInstance) {
                        elements.withdrawModalInstance.hide();
                    }
                }, 2500);
                
                if (currentSectionId === 'wallet-section') {
                    loadRecentTransactions();
                }

            } catch (error) {
                console.error("Withdraw error:", error);
                showStatusMessage(elements.withdrawStatusMessage, `Error: ${error.message}`, 'danger');
                
                // Attempt refund if balance was deducted but request failed
                if (transactionCommitted) {
                    console.warn("Attempting to refund winning cash due to withdrawal request failure...");
                    const userRef = ref(db, `users/${currentUser.uid}`);
                    
                    try {
                        await runTransaction(userRef, (profile) => {
                            if (profile) {
                                profile.winningCash = (profile.winningCash || 0) + amount;
                            }
                            return profile;
                        });
                        
                        await recordTransaction(
                            currentUser.uid, 
                            'withdraw_failed_refund', 
                            amount, 
                            `Refund Failed Withdrawal Request`
                        );
                        
                        console.log("Refund successful.");
                        showStatusMessage(elements.withdrawStatusMessage, `Error: ${error.message}. Amount refunded.`, 'danger');
                    } catch (refundError) {
                        console.error("CRITICAL: FAILED TO REFUND WINNING CASH!", refundError);
                        showStatusMessage(
                            elements.withdrawStatusMessage, 
                            `Error: ${error.message}. CRITICAL: Failed to refund amount! Contact support.`, 
                            'danger', 
                            false
                        );
                    }
                }
            } finally {
                elements.submitWithdrawRequestBtn.disabled = false;
                elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request';
            }
        }

        async function handleMatchDetailsClick(event) {
            console.log("Match Details Clicked");
            
            if (!elements.matchDetailsModalInstance) return;
            
            const tournamentId = event.currentTarget.dataset.tournamentId;
            if (!tournamentId) return;
            
            elements.matchDetailsModalTitle.textContent = 'Loading...';
            elements.matchDetailsModalBody.innerHTML = '<div class="tc p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.matchDetailsModalInstance.show();

            try {
                const tournamentRef = ref(db, `tournaments/${tournamentId}`);
                const snapshot = await get(tournamentRef);
                
                if (snapshot.exists()) {
                    const tournament = snapshot.val();
                    const gameName = appSettings.games?.[tournament.gameId]?.name || tournament.gameId || 'N/A';
                    const startTimeLocal = tournament.startTime ? 
                        new Date(tournament.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short'}) : 
                        'TBA';
                    
                    let prizeDistributionHTML = '';
                    if (tournament.prizeDistribution) {
                        let formattedDistribution = '';
                        
                        if (typeof tournament.prizeDistribution === 'object') {
                            formattedDistribution = Object.entries(tournament.prizeDistribution)
                                .map(([rank, prize]) => `Rank ${rank}: â‚¹${prize}`)
                                .join('\n');
                        } else {
                            formattedDistribution = String(tournament.prizeDistribution).replace(/\\n/g, '\n');
                        }
                        
                        prizeDistributionHTML = `<h5>Prize Distribution:</h5><pre>${formattedDistribution}</pre>`;
                    }
                    
                    const description = tournament.description || 'Standard rules apply.';
                    const formattedDescription = description.replace(/\n/g, '<br>');
                    
                    elements.matchDetailsModalTitle.textContent = tournament.name || 'Match Details';
                    elements.matchDetailsModalBody.innerHTML = `
                        <p><strong>Game:</strong> ${gameName}</p>
                        <p><strong>Mode:</strong> ${tournament.mode || 'N/A'}</p>
                        <p><strong>Map:</strong> ${tournament.map || 'N/A'}</p>
                        <p><strong>Starts:</strong> ${startTimeLocal}</p>
                        <hr>
                        <p><strong>Entry:</strong> ${tournament.entryFee > 0 ? `â‚¹${tournament.entryFee}` : 'Free'}</p>
                        <p><strong>Prize:</strong> â‚¹${tournament.prizePool || 0}</p>
                        <p><strong>Per Kill:</strong> â‚¹${tournament.perKillPrize || 0}</p>
                        <p><strong>Max Players:</strong> ${tournament.maxPlayers > 0 ? tournament.maxPlayers : 'Unlimited'}</p>
                        <hr>
                        <h5>Rules:</h5>
                        <div style="white-space: pre-wrap; line-height: 1.6;">${formattedDescription}</div>
                        ${prizeDistributionHTML}
                    `;
                } else {
                    elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>';
                }
            } catch (error) {
                console.error("Details load failed:", error);
                elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>';
            }
        }

        async function handleIdPasswordClick(event) {
            if (!elements.idPasswordModalInstance) return;
            
            const tournamentId = event.currentTarget.dataset.tournamentId;
            if (!tournamentId) return;

            console.log("--- Checking ID/Pass ---");
            console.log("Tournament ID:", tournamentId);
            console.log("Current User UID:", currentUser?.uid);

            if (!currentUser || !userProfile?.joinedTournaments?.[tournamentId]) {
                console.warn("Client-side check failed: User not logged in or tournament not joined");
                alert("Join the tournament first or refresh the page.");
                return;
            }

            elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.idPasswordModalInstance.show();
            
            try {
                const tournamentRef = ref(db, `tournaments/${tournamentId}`);
                console.log("Fetching from path:", `tournaments/${tournamentId}`);
                
                const snapshot = await get(tournamentRef);
                console.log("Snapshot exists?", snapshot.exists(), "Snapshot value:", snapshot.val());

                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));

                if (snapshot.exists()) {
                    const tournamentData = snapshot.val();
                    
                    if (tournamentData.showIdPass) {
                        elements.roomIdDisplay.textContent = tournamentData.roomId || 'Not updated yet';
                        elements.roomPasswordDisplay.textContent = tournamentData.roomPassword || 'Not updated yet';
                    } else {
                        elements.roomIdDisplay.textContent = 'Hidden by Admin';
                        elements.roomPasswordDisplay.textContent = 'Hidden by Admin';
                    }
                } else {
                    elements.roomIdDisplay.textContent = 'Not Found';
                    elements.roomPasswordDisplay.textContent = 'Not Found';
                }
            } catch (error) {
                console.error("ID/Pass fetch error:", error);
                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
                elements.roomIdDisplay.textContent = 'Error';
                elements.roomPasswordDisplay.textContent = 'Error';
                alert("Error loading ID/Password. Check permissions or network.");
            }
        }

        async function handlePolicyClick(event) {
            console.log("Policy link clicked");
            
            if (!elements.policyModalInstance) {
                console.error("Policy modal instance not found");
                return;
            }
            
            event.preventDefault();
            const target = event.currentTarget;
            const policyType = target.dataset.policy;
            console.log("Policy type requested:", policyType);
            
            if (!policyType) return;

            let title = '';
            let modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.policyModalBody.innerHTML = modalBodyContent;

            switch (policyType) {
                case 'privacy': 
                    title = 'Privacy Policy'; 
                    modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; 
                    break;
                case 'terms': 
                    title = 'Terms and Conditions'; 
                    modalBodyContent = appSettings.policyTerms || 'Content not available.'; 
                    break;
                case 'refund': 
                    title = 'Refund and Cancellation'; 
                    modalBodyContent = appSettings.policyRefund || 'Content not available.'; 
                    break;
                case 'fairPlay': 
                    title = 'Fair Play Policy'; 
                    modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; 
                    break;
                case 'refer':
                    title = 'Refer & Earn';
                    if (!currentUser) {
                        alert("Login to view referral.");
                        return;
                    }
                    const referralCode = userProfile.referralCode || 'N/A';
                    const referralBonus = appSettings?.referralBonus || 0;
                    const referralDescription = appSettings?.referralDescription || `Get â‚¹${referralBonus} when your friend joins using your code.`;
                    
                    modalBodyContent = `
                        <div class="text-center">
                            <h4>Refer Friends!</h4>
                            <p class="text-secondary">Share code & earn!</p>
                            <div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                                <p class="small text-secondary mb-1">Your Code:</p>
                                <h3 class="text-accent referral-code" id="referralCodeDisplay">${referralCode}</h3>
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                    <button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn">
                                        <i class="bi bi-share-fill"></i> Share
                                    </button>
                                </div>
                            </div>
                            <p class="mt-3 small text-secondary">${referralDescription}</p>
                        </div>
                    `;
                    break;
                default:
                    title = 'Info';
                    console.warn("Unknown policy:", policyType);
                    modalBodyContent = '<p>Content unavailable.</p>';
            }

            elements.policyModalTitle.textContent = title;
            
            if (typeof modalBodyContent === 'string' && policyType !== 'refer') {
                elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>');
            } else {
                elements.policyModalBody.innerHTML = modalBodyContent;
            }
            
            console.log("Showing policy modal for:", policyType);
            elements.policyModalInstance.show();
        }

        // --- Edit Profile Functions ---
        function handleEditProfileClick() {
            if (!currentUser || !elements.editProfileModalInstance) return;
            
            // Populate the form with current user data
            elements.editProfileNameInput.value = userProfile.displayName || '';
            elements.editProfileEmailInput.value = currentUser.email || '';
            elements.editProfilePhoneInput.value = userProfile.phoneNumber || '';
            elements.editProfileAvatar.src = userProfile.photoURL || elements.profileAvatar.src;
            
            clearStatusMessage(elements.editProfileStatusMessage);
            elements.editProfileModalInstance.show();
        }

        async function handleSaveProfileClick() {
            if (!currentUser) return;
            
            const newName = elements.editProfileNameInput.value.trim();
            const phoneNumber = elements.editProfilePhoneInput.value.trim();
            
            if (!newName) {
                showStatusMessage(elements.editProfileStatusMessage, 'Name is required.', 'warning');
                return;
            }
            
            elements.saveProfileBtn.disabled = true;
            elements.saveProfileBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            
            try {
                const updates = {};
                
                // Update display name if changed
                if (newName !== userProfile.displayName) {
                    updates.displayName = newName;
                    
                    // Also update Firebase Auth display name
                    await updateProfile(currentUser, {
                        displayName: newName
                    });
                }
                
                // Update phone number if changed
                if (phoneNumber !== userProfile.phoneNumber) {
                    updates.phoneNumber = phoneNumber;
                }
                
                // Update database if there are changes
                if (Object.keys(updates).length > 0) {
                    const userRef = ref(db, `users/${currentUser.uid}`);
                    await update(userRef, updates);
                    
                    // Update local profile
                    userProfile = { ...userProfile, ...updates };
                    
                    // Update UI
                    populateUserInfo(currentUser, userProfile);
                    
                    showStatusMessage(elements.editProfileStatusMessage, 'Profile updated successfully!', 'success');
                    
                    setTimeout(() => {
                        elements.editProfileModalInstance.hide();
                    }, 1500);
                } else {
                    showStatusMessage(elements.editProfileStatusMessage, 'No changes to save.', 'info');
                }
            } catch (error) {
                console.error("Profile update error:", error);
                showStatusMessage(elements.editProfileStatusMessage, `Error: ${error.message}`, 'danger');
            } finally {
                elements.saveProfileBtn.disabled = false;
                elements.saveProfileBtn.innerHTML = 'Save Changes';
            }
        }

        // --- Realtime Listeners Setup ---
        function setupRealtimeListeners(uid) {
            if (!uid || !db || !currentUser) return;
            
            detachAllDbListeners();
            
            console.log("Setting up realtime listener for User Profile:", uid);
            const userRef = ref(db, `users/${uid}`);
            
            const listenerFunction = onValue(userRef, (snapshot) => {
                if (currentUser && currentUser.uid === uid) {
                    if (snapshot.exists()) {
                        console.log("Realtime: User Profile Update Received");
                        userProfile = snapshot.val();
                        populateUserInfo(currentUser, userProfile);
                        
                        if (currentSectionId === 'home-section') {
                            loadMyContests();
                        }
                        
                        if (currentSectionId === 'wallet-section') {
                            loadRecentTransactions();
                        }
                    } else {
                        console.warn("User data deleted (realtime) for:", uid);
                        alert("Account data missing or deleted. Logging out.");
                        logoutUser();
                    }
                } else {
                    console.log("Realtime listener fired for a different user or logged-out state. Detaching.");
                    off(userRef, 'value', listenerFunction);
                }
            }, (error) => {
                console.error("Listener error (user profile):", error);
            });
            
            dbListeners['userProfile'] = { path: `users/${uid}`, func: listenerFunction };
        }

        function detachAllDbListeners() {
            console.log("Detaching listeners:", Object.keys(dbListeners));
            let count = 0;
            
            for (const key in dbListeners) {
                try {
                    const { path, func } = dbListeners[key];
                    if (path && func) {
                        off(ref(db, path), 'value', func);
                        count++;
                    } else {
                        console.warn(`Listener object invalid for key: ${key}`);
                    }
                } catch (error) {
                    console.error(`Detach error ${key}:`, error);
                }
            }
            
            dbListeners = {};
            console.log(`Detached ${count} listeners.`);
        }

        // --- Security Rules Check ---
        async function checkSecurityRules() {
            console.log("Checking security rules...");
            
            try {
                if (!currentUser) {
                    console.log("Security rule check skipped for anonymous user");
                } else if (elements.securityWarning) {
                    elements.securityWarning.style.display = 'none';
                }
            } catch (error) {
                console.log("Security rule check result:", error.message);
                if (elements.securityWarning) {
                    elements.securityWarning.style.display = 'none';
                }
            }
        }

        // --- Data Refresh Function ---
        function refreshData() {
            if (!currentUser) return;
            
            console.log("Manual data refresh triggered");
            showLoader(true);
            
            // Force reload current section data
            switch (currentSectionId) {
                case 'home-section': 
                    loadHomePageData(); 
                    break;
                case 'wallet-section': 
                    loadWalletData(); 
                    break;
                case 'profile-section': 
                    loadProfileData(); 
                    break;
                case 'earnings-section': 
                    loadEarningsData(); 
                    break;
                case 'tournaments-section':
                    if (currentTournamentGameId) {
                        const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                        filterTournaments(currentTournamentGameId, activeTab);
                    }
                    break;
            }
            
            // Also reload app settings in case they changed
            loadAppSettings();
            
            setTimeout(() => {
                showLoader(false);
                alert("Data refreshed successfully!");
            }, 1000);
        }

        // --- Event Listeners Initialization ---
        function initializeEventListeners() {
            if (!elements) return;
            
            console.log("Initializing listeners...");
            
            // Bottom Nav
            elements.bottomNavItems?.forEach(item => {
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    showSection(item.dataset.section);
                });
            });
            
            // Header Back
            elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));
            
            // Tournament Tabs
            elements.tournamentTabs?.forEach(tab => {
                tab.addEventListener('click', (event) => {
                    const status = event.currentTarget.dataset.status;
                    if (currentTournamentGameId && status) {
                        elements.tournamentTabs.forEach(t => t.classList.remove('active'));
                        event.currentTarget.classList.add('active');
                        filterTournaments(currentTournamentGameId, status);
                    }
                });
            });

            // Login/Signup Forms
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
            elements.forgotPasswordLink?.addEventListener('click', (event) => {
                event.preventDefault();
                resetPassword();
            });

            // Profile Actions
            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.editProfileBtn?.addEventListener('click', handleEditProfileClick);
            elements.saveProfileBtn?.addEventListener('click', handleSaveProfileClick);
            elements.changeAvatarBtn?.addEventListener('click', () => {
                alert('Avatar change functionality will be implemented in the next version.');
            });
            
            elements.policyLinks?.forEach(link => {
                link.addEventListener('click', handlePolicyClick);
            });
            
            elements.notificationSwitch?.addEventListener('change', (event) => {
                console.log("Notification toggle:", event.target.checked);
            });

            // Wallet Actions
            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', () => {
                if (currentUser && elements.addAmountModalInstance) {
                    if (elements.modalUserEmail) {
                        elements.modalUserEmail.textContent = currentUser.email || 'N/A';
                    }
                    elements.addAmountModalInstance.show();
                } else if (!currentUser) {
                    alert("Login first.");
                    showSection('login-section');
                }
            });
            
            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
            elements.copyUpiIdBtn?.addEventListener('click', () => {
                copyToClipboard('#upiIdDisplay');
            });

            // Other Actions
            elements.notificationBtn?.addEventListener('click', () => alert('Notifications coming soon!'));
            elements.allTransactionsBtn?.addEventListener('click', () => alert('Transaction history page coming soon!'));
            elements.viewEarningsHistoryBtn?.addEventListener('click', () => alert('Earnings history coming soon!'));
            elements.refreshDataBtn?.addEventListener('click', refreshData);

            // Delegated Event Listener for Copy/Share buttons
            document.body.addEventListener('click', (event) => {
                // Copy Button
                if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) {
                    const button = event.target.closest('.copy-btn');
                    const targetSelector = button.dataset.target;
                    
                    if (targetSelector) {
                        copyToClipboard(targetSelector);
                    } else {
                        console.warn("Copy button missing data-target selector.");
                    }
                }
                
                // Share Button (in Refer modal)
                if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) {
                    const codeElement = getElement('referralCodeDisplay');
                    if (codeElement) {
                        shareReferral(codeElement.textContent);
                    }
                }
            });
            
            console.log("Listeners initialized.");
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Init App...");
            
            if (typeof initializeApp !== 'function' || !auth || !db) {
                console.error("Firebase SDK failed/not ready. Cannot proceed.");
                return;
            }
            
            showLoader(true);
            
            loadAppSettings()
                .then(() => {
                    console.log("Settings loaded, initializing listeners and auth state...");
                    initializeEventListeners();
                    updateGlobalUI(false);
                    onAuthStateChanged(auth, handleAuthStateChange);
                })
                .catch(error => {
                    console.error("CRITICAL: Initial settings load failed:", error);
                    alert("Error loading essential app settings. Please try again later.");
                    initializeEventListeners();
                    updateGlobalUI(false);
                    onAuthStateChanged(auth, handleAuthStateChange);
                });
        });

    </script>

</body>
</html>
